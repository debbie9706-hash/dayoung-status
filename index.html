<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¤ì˜ì´ ìƒíƒœ ì•Œë¦¼</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#6366F1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ë‹¤ì˜ì´ ìƒíƒœ">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <style>
        :root{--primary:#6366F1;--primary-light:#818CF8;--primary-dark:#4F46E5;--secondary:#EC4899;--success:#10B981;--warning:#F59E0B;--danger:#EF4444;--bg:#F8FAFC;--card:#FFFFFF;--text:#1E293B;--text-muted:#64748B;--border:#E2E8F0;--shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -2px rgba(0,0,0,0.1);--shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -4px rgba(0,0,0,0.1)}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:-apple-system,BlinkMacSystemFont,'Malgun Gothic','ë§‘ì€ ê³ ë”•',sans-serif;background:var(--bg);min-height:100vh;min-height:100dvh;color:var(--text);line-height:1.6;overflow-x:hidden}
        .app{max-width:480px;margin:0 auto;padding:16px;padding-bottom:100px}
        .header{text-align:center;padding:24px 0;margin-bottom:16px}
        .header-icon{width:72px;height:72px;background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);border-radius:24px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:36px;box-shadow:var(--shadow-lg)}
        .header h1{font-size:1.5rem;font-weight:700;margin-bottom:4px}
        .header p{font-size:0.9rem;color:var(--text-muted)}
        .role-selector{display:flex;gap:10px;margin-bottom:20px}
        .role-btn{flex:1;padding:14px;border:2px solid var(--border);border-radius:14px;background:white;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.2s}
        .role-btn.active{border-color:var(--primary);background:#EEF2FF;color:var(--primary)}
        .role-btn:active{transform:scale(0.98)}
        .push-banner{background:linear-gradient(135deg,var(--success) 0%,#059669 100%);border-radius:16px;padding:16px;margin-bottom:16px;color:white;display:none}
        .push-banner.show{display:block}
        .push-banner-content{display:flex;align-items:center;gap:12px}
        .push-banner h3{font-size:0.95rem;margin-bottom:4px}
        .push-banner p{font-size:0.8rem;opacity:0.9}
        .push-btn{margin-top:12px;width:100%;padding:12px;background:white;color:var(--success);border:none;border-radius:10px;font-weight:600;cursor:pointer}
        .push-status{background:var(--card);border-radius:12px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;font-size:0.9rem;box-shadow:var(--shadow)}
        .push-status.enabled{background:#ECFDF5;color:#047857}
        .push-status.disabled{background:#FEF2F2;color:#B91C1C}
        .update-banner{background:var(--card);border-radius:16px;padding:16px 20px;margin-bottom:16px;display:flex;align-items:center;gap:14px;box-shadow:var(--shadow)}
        .update-indicator{width:10px;height:10px;background:var(--success);border-radius:50%;animation:pulse 2s infinite;flex-shrink:0}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .update-info{flex:1}
        .update-label{font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
        .update-time{font-size:1rem;font-weight:600}
        .update-date{font-size:0.85rem;color:var(--text-muted);margin-top:2px}
        .update-ago{font-size:0.8rem;color:var(--primary);font-weight:500}
        .status-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
        .status-card{background:var(--card);border-radius:20px;padding:20px 16px;text-align:center;box-shadow:var(--shadow);border:2px solid transparent}
        .status-card.location-going_home{border-color:#A5F3FC;background:linear-gradient(180deg,#ECFEFF 0%,white 100%)}
        .status-card.location-at_home{border-color:#BBF7D0;background:linear-gradient(180deg,#F0FDF4 0%,white 100%)}
        .status-card.location-outside{border-color:#FDE68A;background:linear-gradient(180deg,#FFFBEB 0%,white 100%)}
        .status-card.location-busy{border-color:#FECACA;background:linear-gradient(180deg,#FEF2F2 0%,white 100%)}
        .status-card.hunger-hungry{border-color:#FBCFE8;background:linear-gradient(180deg,#FDF2F8 0%,white 100%)}
        .status-card.hunger-not_hungry{border-color:#C7D2FE;background:linear-gradient(180deg,#EEF2FF 0%,white 100%)}
        .status-label{font-size:0.8rem;color:var(--text-muted);margin-bottom:8px;font-weight:500}
        .status-emoji{font-size:2.8rem;margin-bottom:8px;line-height:1}
        .status-text{font-size:0.95rem;font-weight:600;word-break:keep-all}
        .section{background:var(--card);border-radius:20px;padding:20px;margin-bottom:16px;box-shadow:var(--shadow)}
        .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
        .section-header-left{display:flex;align-items:center;gap:10px}
        .section-icon{width:36px;height:36px;background:linear-gradient(135deg,#FBBF24 0%,#F59E0B 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
        .section-icon.dayoung{background:linear-gradient(135deg,#EC4899 0%,#DB2777 100%)}
        .section-title{font-size:1rem;font-weight:600}
        .admin-badge{padding:4px 10px;background:var(--danger);color:white;border-radius:20px;font-size:0.7rem;font-weight:600;display:none}
        .admin-badge.active{display:inline-block}
        .mood-display{display:flex;align-items:center;gap:12px;padding:14px 16px;background:#FFFBEB;border-radius:14px;margin-bottom:16px}
        .mood-emoji{font-size:2rem}
        .mood-info{flex:1}
        .mood-text{font-weight:600}
        .mood-time{font-size:0.8rem;color:var(--text-muted)}
        .mood-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px}
        .mood-btn{aspect-ratio:1;border:2px solid var(--border);border-radius:14px;background:white;cursor:pointer;font-size:1.5rem;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
        .mood-btn:active{transform:scale(0.95)}
        .mood-btn.selected{border-color:var(--primary);background:#EEF2FF;transform:scale(1.05)}
        .status-selector{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
        .status-option{padding:12px;border:2px solid var(--border);border-radius:12px;background:white;cursor:pointer;text-align:center;font-size:0.9rem;transition:all 0.2s}
        .status-option:active{transform:scale(0.98)}
        .status-option.selected{border-color:var(--primary);background:#EEF2FF}
        .status-option .emoji{font-size:1.5rem;display:block;margin-bottom:4px}
        .input-group{margin-bottom:14px}
        .input-label{display:flex;align-items:center;gap:6px;font-size:0.85rem;font-weight:500;margin-bottom:8px}
        .input-field{width:100%;padding:14px 16px;border:2px solid var(--border);border-radius:14px;font-size:0.95rem;font-family:inherit;resize:none;min-height:70px}
        .input-field:focus{outline:none;border-color:var(--primary);background:#FAFAFF}
        .btn{width:100%;padding:16px;border:none;border-radius:14px;font-size:1rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn:active{transform:scale(0.98)}
        .btn-primary{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white}
        .btn-secondary{background:var(--text);color:white}
        .btn-pink{background:linear-gradient(135deg,#EC4899 0%,#DB2777 100%);color:white}
        .message-section-header{display:flex;align-items:center;justify-content:space-between;margin:16px 0 12px}
        .message-section-title{font-size:0.9rem;font-weight:600;color:var(--text)}
        .message-list{max-height:400px;overflow-y:auto;-webkit-overflow-scrolling:touch}
        .message-empty{text-align:center;padding:32px 16px;color:var(--text-muted);font-size:0.9rem}
        .date-group{margin-bottom:16px}
        .date-header{display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:8px 12px;background:linear-gradient(90deg,#EEF2FF 0%,transparent 100%);border-radius:8px}
        .date-header-icon{font-size:0.9rem}
        .date-header-text{font-size:0.85rem;font-weight:600;color:var(--primary)}
        .date-header-count{font-size:0.75rem;color:var(--text-muted);margin-left:auto}
        .message-item{padding:14px;background:#F8FAFC;border-radius:14px;margin-bottom:8px;border-left:3px solid var(--primary)}
        .message-item:last-child{margin-bottom:0}
        .message-item.advice{border-left-color:var(--secondary)}
        .message-item.memo{border-left-color:var(--success)}
        .message-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
        .message-meta{display:flex;align-items:center;gap:8px}
        .message-badge{padding:3px 8px;border-radius:6px;font-size:0.7rem;font-weight:600}
        .message-badge.message{background:#DBEAFE;color:#1D4ED8}
        .message-badge.advice{background:#FCE7F3;color:#BE185D}
        .message-badge.memo{background:#D1FAE5;color:#047857}
        .message-sender{font-size:0.8rem;font-weight:500;color:var(--text-muted)}
        .message-actions{display:flex;gap:4px}
        .msg-action-btn{width:28px;height:28px;border:none;border-radius:8px;background:white;cursor:pointer;font-size:0.75rem;display:flex;align-items:center;justify-content:center}
        .msg-action-btn.delete{color:var(--danger)}
        .message-content{font-size:0.9rem;line-height:1.5;word-break:keep-all}
        .message-time{font-size:0.75rem;color:var(--text-muted);margin-top:6px}
        .fab{position:fixed;bottom:24px;right:24px;width:60px;height:60px;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);border:none;border-radius:50%;color:white;font-size:24px;cursor:pointer;box-shadow:0 4px 15px rgba(99,102,241,0.4);display:flex;align-items:center;justify-content:center;z-index:100}
        .fab:active{transform:scale(0.95)}
        .fab.spinning span{animation:spin 1s linear infinite}
        @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
        .loading{text-align:center;padding:60px 20px}
        .loading-spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
        .loading-text{color:var(--text-muted);font-size:0.95rem}
        .toast{position:fixed;top:24px;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--text);color:white;padding:14px 24px;border-radius:12px;font-size:0.95rem;z-index:1000;transition:transform 0.3s ease;max-width:calc(100% - 32px);text-align:center}
        .toast.show{transform:translateX(-50%) translateY(0)}
        @media(max-width:360px){.status-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="header-icon">ğŸ’•</div>
            <h1>ë‹¤ì˜ì´ ìƒíƒœ</h1>
            <p>ì„œë¡œì˜ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </header>

        <!-- ì—­í•  ì„ íƒ -->
        <div class="role-selector">
            <button class="role-btn" id="roleDad" onclick="setRole('dad')">ğŸ‘¨ ì•„ë²„ì§€</button>
            <button class="role-btn" id="roleDayoung" onclick="setRole('dayoung')">ğŸ‘§ ë‹¤ì˜</button>
        </div>

        <!-- Push ì•Œë¦¼ ë°°ë„ˆ -->
        <div class="push-banner" id="pushBanner">
            <div class="push-banner-content">
                <span style="font-size:2rem">ğŸ””</span>
                <div>
                    <h3>ì•Œë¦¼ì„ ì¼œì‹œê² ì–´ìš”?</h3>
                    <p>ìƒëŒ€ë°©ì´ ìƒíƒœë¥¼ ë³€ê²½í•˜ë©´ ì•Œë¦¼ì„ ë°›ì•„ìš”</p>
                </div>
            </div>
            <button class="push-btn" onclick="subscribePush()">ì•Œë¦¼ í—ˆìš©í•˜ê¸°</button>
        </div>

        <!-- Push ìƒíƒœ í‘œì‹œ -->
        <div class="push-status disabled" id="pushStatus" style="display:none">
            <span>ğŸ”•</span>
            <span>ì•Œë¦¼ì´ êº¼ì ¸ìˆì–´ìš”</span>
        </div>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <div id="statusView" style="display:none;">
            <!-- ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ -->
            <div class="update-banner">
                <div class="update-indicator"></div>
                <div class="update-info">
                    <div class="update-label">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
                    <div class="update-time" id="lastUpdateTime">--:--</div>
                    <div class="update-date" id="lastUpdateDate">----ë…„ --ì›” --ì¼</div>
                </div>
                <div class="update-ago" id="lastUpdateAgo"></div>
            </div>

            <!-- ìƒíƒœ ì¹´ë“œ -->
            <div class="status-grid">
                <div id="locationCard" class="status-card location-going_home">
                    <div class="status-label">ğŸ“ ë‹¤ì˜ì´ëŠ” ì§€ê¸ˆ</div>
                    <div id="locationEmoji" class="status-emoji">ğŸ </div>
                    <div id="locationText" class="status-text">ì§‘ì— ê°€ê³  ìˆì–´ìš”</div>
                </div>
                <div id="hungerCard" class="status-card hunger-not_hungry">
                    <div class="status-label">ğŸš ë°¥ì€</div>
                    <div id="hungerEmoji" class="status-emoji">ğŸ˜Š</div>
                    <div id="hungerText" class="status-text">ë°°ê°€ ì•ˆ ê³ íŒŒìš”</div>
                </div>
            </div>

            <!-- ë‹¤ì˜ì´ ì „ìš©: ìƒíƒœ ë³€ê²½ -->
            <div class="section" id="dayoungSection" style="display:none">
                <div class="section-header">
                    <div class="section-header-left">
                        <div class="section-icon dayoung">ğŸ‘§</div>
                        <div class="section-title">ë‚´ ìƒíƒœ ë³€ê²½</div>
                    </div>
                </div>

                <div class="input-label">ğŸ“ ì§€ê¸ˆ ì–´ë””ì— ìˆì–´ìš”?</div>
                <div class="status-selector" id="locationSelector">
                    <div class="status-option" data-value="going_home"><span class="emoji">ğŸš¶</span>ì§‘ì— ê°€ëŠ” ì¤‘</div>
                    <div class="status-option" data-value="at_home"><span class="emoji">ğŸ </span>ì§‘ì— ë„ì°©!</div>
                    <div class="status-option" data-value="outside"><span class="emoji">ğŸŒ™</span>ì•„ì§ ë°–ì—</div>
                    <div class="status-option" data-value="busy"><span class="emoji">ğŸ’¼</span>ë°”ë¹ ìš”</div>
                </div>

                <div class="input-label">ğŸš ë°°ê³ íŒŒìš”?</div>
                <div class="status-selector" id="hungerSelector">
                    <div class="status-option" data-value="not_hungry"><span class="emoji">ğŸ˜Š</span>ì•ˆ ê³ íŒŒìš”</div>
                    <div class="status-option" data-value="hungry"><span class="emoji">ğŸ½ï¸</span>ë°°ê³ íŒŒìš”!</div>
                </div>

                <div class="input-group">
                    <label class="input-label">ğŸ’¬ ì•„ë²„ì§€ì—ê²Œ ë©”ì‹œì§€</label>
                    <textarea id="dayoungMessageInput" class="input-field" placeholder="ì•„ë²„ì§€ì—ê²Œ í•˜ê³  ì‹¶ì€ ë§..."></textarea>
                </div>

                <button class="btn btn-pink" onclick="saveDayoungStatus()">
                    <span>ğŸ’•</span><span>ìƒíƒœ ì €ì¥í•˜ê¸°</span>
                </button>
            </div>

            <!-- ì•„ë²„ì§€ ì „ìš©: ì •ë³´ ì…ë ¥ -->
            <div class="section" id="dadSection" style="display:none">
                <div class="section-header">
                    <div class="section-header-left">
                        <div class="section-icon">ğŸ‘¨</div>
                        <div class="section-title">ì•„ë²„ì§€</div>
                    </div>
                </div>

                <div class="mood-display">
                    <div class="mood-emoji" id="fatherMoodDisplay">ğŸ˜</div>
                    <div class="mood-info">
                        <div class="mood-text" id="fatherMoodText">ë³´í†µ</div>
                        <div class="mood-time" id="fatherMoodTime">ì—…ë°ì´íŠ¸ ì—†ìŒ</div>
                    </div>
                </div>

                <div class="input-label">ì˜¤ëŠ˜ ê¸°ë¶„ì€ ì–´ë– ì„¸ìš”?</div>
                <div class="mood-grid" id="moodSelector">
                    <button class="mood-btn" data-mood="good">ğŸ˜Š</button>
                    <button class="mood-btn" data-mood="normal">ğŸ˜</button>
                    <button class="mood-btn" data-mood="tired">ğŸ˜”</button>
                    <button class="mood-btn" data-mood="angry">ğŸ˜¡</button>
                    <button class="mood-btn" data-mood="sad">ğŸ˜¢</button>
                </div>

                <div class="input-group">
                    <label class="input-label">ğŸ’¬ í•˜ê³ ì‹¶ì€ ë§</label>
                    <textarea id="fatherMessageInput" class="input-field" placeholder="ë‹¤ì˜ì´ì—ê²Œ í•˜ê³ ì‹¶ì€ ë§..."></textarea>
                </div>

                <div class="input-group">
                    <label class="input-label">â¤ï¸ ë‹¹ë¶€í•  ë§</label>
                    <textarea id="fatherAdviceInput" class="input-field" placeholder="ë‹¤ì˜ì´ì—ê²Œ ë‹¹ë¶€í•˜ê³  ì‹¶ì€ ë§..."></textarea>
                </div>

                <div class="input-group">
                    <label class="input-label">ğŸ“ ê¸°íƒ€ ë©”ëª¨</label>
                    <textarea id="fatherMemoInput" class="input-field" placeholder="ê¸°íƒ€ ì‚¬í•­ ë©”ëª¨..."></textarea>
                </div>

                <button class="btn btn-secondary" onclick="saveFatherInfo()">
                    <span>ğŸ’¾</span><span>ì €ì¥í•˜ê¸°</span>
                </button>
            </div>

            <!-- ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ -->
            <div class="section">
                <div class="message-section-header">
                    <div class="message-section-title">ğŸ“‹ ë©”ì‹œì§€ ê¸°ë¡</div>
                </div>
                <div id="messageHistory" class="message-list">
                    <div class="message-empty">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ì–´ìš”</div>
                </div>
            </div>
        </div>
    </div>

    <button id="refreshBtn" class="fab"><span>ğŸ”„</span></button>
    <div id="toast" class="toast"></div>

    <script>
        const API_URL = 'https://dayoung-api-v2-937334177552.asia-northeast3.run.app';
        const VAPID_PUBLIC_KEY = 'BISWYP4b39HB7lx9Ciar56lXPzV8ZI51l5u8L_jqFtFg2Ci12A9EN1bF_EIfKAvCnKBLrfbu32k-n-m4TucuZEw';

        let currentRole = localStorage.getItem('userRole') || null;
        let fatherMood = 'normal';
        let selectedLocation = null;
        let selectedHunger = null;
        let lastUpdateTimestamp = null;

        const moodMap = {good:{emoji:'ğŸ˜Š',text:'ì¢‹ìŒ'},normal:{emoji:'ğŸ˜',text:'ë³´í†µ'},tired:{emoji:'ğŸ˜”',text:'í”¼ê³¤'},angry:{emoji:'ğŸ˜¡',text:'í™”ë‚¨'},sad:{emoji:'ğŸ˜¢',text:'ìŠ¬í””'}};
        const locationMap = {going_home:{emoji:'ğŸš¶',text:'ì§‘ì— ê°€ê³  ìˆì–´ìš”'},at_home:{emoji:'ğŸ ',text:'ì§‘ì— ë„ì°©í–ˆì–´ìš”!'},outside:{emoji:'ğŸŒ™',text:'ì•„ì§ ë°–ì— ìˆì–´ìš”'},busy:{emoji:'ğŸ’¼',text:'ì§€ê¸ˆ ë°”ë¹ ìš”'}};
        const hungerMap = {not_hungry:{emoji:'ğŸ˜Š',text:'ë°° ì•ˆ ê³ íŒŒìš”'},hungry:{emoji:'ğŸ½ï¸',text:'ë°°ê³ íŒŒìš”'}};

        document.addEventListener('DOMContentLoaded', () => {
            if (currentRole) {
                document.getElementById(`role${currentRole === 'dad' ? 'Dad' : 'Dayoung'}`).classList.add('active');
                updateUIForRole();
            }
            fetchStatus();
            setupEventListeners();
            registerServiceWorker();
            checkPushSubscription();
            setInterval(updateTimeAgo, 60000);
        });

        function setRole(role) {
            currentRole = role;
            localStorage.setItem('userRole', role);
            document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`role${role === 'dad' ? 'Dad' : 'Dayoung'}`).classList.add('active');
            updateUIForRole();
            checkPushSubscription();
        }

        function updateUIForRole() {
            document.getElementById('dadSection').style.display = currentRole === 'dad' ? 'block' : 'none';
            document.getElementById('dayoungSection').style.display = currentRole === 'dayoung' ? 'block' : 'none';
        }

        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const reg = await navigator.serviceWorker.register('./sw.js');
                    console.log('SW ë“±ë¡ ì„±ê³µ');
                } catch (e) {
                    console.log('SW ë“±ë¡ ì‹¤íŒ¨:', e);
                }
            }
        }

        async function checkPushSubscription() {
            if (!currentRole) return;
            
            const pushStatus = document.getElementById('pushStatus');
            const pushBanner = document.getElementById('pushBanner');

            if (!('PushManager' in window)) {
                pushStatus.style.display = 'flex';
                pushStatus.className = 'push-status disabled';
                pushStatus.innerHTML = '<span>âŒ</span><span>ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”</span>';
                return;
            }

            const reg = await navigator.serviceWorker.ready;
            const sub = await reg.pushManager.getSubscription();

            if (sub) {
                pushStatus.style.display = 'flex';
                pushStatus.className = 'push-status enabled';
                pushStatus.innerHTML = '<span>ğŸ””</span><span>ì•Œë¦¼ì´ ì¼œì ¸ìˆì–´ìš”</span>';
                pushBanner.classList.remove('show');
            } else {
                pushBanner.classList.add('show');
                pushStatus.style.display = 'none';
            }
        }

        async function subscribePush() {
            if (!currentRole) {
                showToast('ë¨¼ì € ì—­í• ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }

            try {
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    showToast('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆì–´ìš”');
                    return;
                }

                const reg = await navigator.serviceWorker.ready;
                const sub = await reg.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });

                await fetch(`${API_URL}/subscribe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subscription: sub.toJSON(), role: currentRole })
                });

                showToast('ğŸ”” ì•Œë¦¼ì´ ë“±ë¡ë˜ì—ˆì–´ìš”!');
                checkPushSubscription();
            } catch (e) {
                console.error('Push êµ¬ë… ì‹¤íŒ¨:', e);
                showToast('ì•Œë¦¼ ë“±ë¡ì— ì‹¤íŒ¨í–ˆì–´ìš”');
            }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
        }

        function setupEventListeners() {
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    fatherMood = btn.dataset.mood;
                });
            });

            document.querySelectorAll('#locationSelector .status-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    document.querySelectorAll('#locationSelector .status-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    selectedLocation = opt.dataset.value;
                });
            });

            document.querySelectorAll('#hungerSelector .status-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    document.querySelectorAll('#hungerSelector .status-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    selectedHunger = opt.dataset.value;
                });
            });

            document.getElementById('refreshBtn').addEventListener('click', () => {
                const btn = document.getElementById('refreshBtn');
                btn.classList.add('spinning');
                fetchStatus().then(() => {
                    btn.classList.remove('spinning');
                    showToast('âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ!');
                });
            });
        }

        async function saveDayoungStatus() {
            const message = document.getElementById('dayoungMessageInput').value.trim();

            if (!selectedLocation && !selectedHunger && !message) {
                showToast('ë³€ê²½í•  ë‚´ìš©ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }

            try {
                const body = {};
                if (selectedLocation) body.location = selectedLocation;
                if (selectedHunger) body.hunger = selectedHunger;
                if (message) body.dayoungMessage = message;

                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await res.json();
                updateDisplay(data);
                document.getElementById('dayoungMessageInput').value = '';
                showToast('ğŸ’• ìƒíƒœê°€ ì €ì¥ë˜ì—ˆì–´ìš”!');
            } catch (e) {
                showToast('âŒ ì €ì¥ ì‹¤íŒ¨');
            }
        }

        async function saveFatherInfo() {
            const message = document.getElementById('fatherMessageInput').value.trim();
            const advice = document.getElementById('fatherAdviceInput').value.trim();
            const memo = document.getElementById('fatherMemoInput').value.trim();

            if (!fatherMood && !message && !advice && !memo) {
                showToast('ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            try {
                const body = {};
                if (fatherMood) body.fatherMood = fatherMood;
                if (message) body.fatherMessage = message;
                if (advice) body.fatherAdvice = advice;
                if (memo) body.fatherMemo = memo;

                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await res.json();
                updateDisplay(data);
                document.getElementById('fatherMessageInput').value = '';
                document.getElementById('fatherAdviceInput').value = '';
                document.getElementById('fatherMemoInput').value = '';
                showToast('âœ… ì €ì¥ ì™„ë£Œ!');
            } catch (e) {
                showToast('âŒ ì €ì¥ ì‹¤íŒ¨');
            }
        }

        async function fetchStatus() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('statusView').style.display = 'block';
                updateDisplay(data);
                return data;
            } catch (e) {
                document.getElementById('loading').innerHTML = '<div style="font-size:3em;margin-bottom:15px;">ğŸ˜¢</div><div class="loading-text">ì—°ê²°í•  ìˆ˜ ì—†ì–´ìš”</div>';
            }
        }

        function updateDisplay(data) {
            const locationTime = data.locationUpdated ? new Date(data.locationUpdated) : null;
            const hungerTime = data.hungerUpdated ? new Date(data.hungerUpdated) : null;
            let latestTime = locationTime;
            if (hungerTime && (!latestTime || hungerTime > latestTime)) latestTime = hungerTime;
            
            if (latestTime) {
                lastUpdateTimestamp = latestTime;
                document.getElementById('lastUpdateTime').textContent = formatTime(latestTime);
                document.getElementById('lastUpdateDate').textContent = formatFullDate(latestTime);
                document.getElementById('lastUpdateAgo').textContent = formatTimeAgo(latestTime);
            }

            const location = locationMap[data.location] || locationMap['going_home'];
            document.getElementById('locationEmoji').textContent = location.emoji;
            document.getElementById('locationText').textContent = location.text;
            document.getElementById('locationCard').className = 'status-card location-' + (data.location || 'going_home');

            const hunger = hungerMap[data.hunger] || hungerMap['not_hungry'];
            document.getElementById('hungerEmoji').textContent = hunger.emoji;
            document.getElementById('hungerText').textContent = hunger.text;
            document.getElementById('hungerCard').className = 'status-card hunger-' + (data.hunger || 'not_hungry');

            if (data.fatherMood) {
                const mood = moodMap[data.fatherMood];
                document.getElementById('fatherMoodDisplay').textContent = mood.emoji;
                document.getElementById('fatherMoodText').textContent = mood.text;
                if (data.fatherMoodUpdated) {
                    document.getElementById('fatherMoodTime').textContent = formatTime(new Date(data.fatherMoodUpdated));
                }
            }

            displayMessageHistory(data.messages);
        }

        function displayMessageHistory(messages) {
            const history = document.getElementById('messageHistory');
            if (!messages || messages.length === 0) {
                history.innerHTML = '<div class="message-empty">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ì–´ìš”</div>';
                return;
            }

            const grouped = {};
            messages.forEach(msg => {
                const dateKey = new Date(msg.timestamp).toISOString().split('T')[0];
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(msg);
            });

            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
            const typeText = {message:'ğŸ’¬ ë©”ì‹œì§€',advice:'â¤ï¸ ë‹¹ë¶€',memo:'ğŸ“ ë©”ëª¨'};
            const typeClass = {message:'message',advice:'advice',memo:'memo'};

            let html = '';
            sortedDates.forEach(dateKey => {
                const msgs = grouped[dateKey];
                const displayDate = formatGroupDate(new Date(dateKey));
                
                html += `<div class="date-group"><div class="date-header"><span class="date-header-icon">ğŸ“…</span><span class="date-header-text">${displayDate}</span><span class="date-header-count">${msgs.length}ê°œ</span></div>`;
                
                msgs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                msgs.forEach(msg => {
                    html += `<div class="message-item ${typeClass[msg.type] || 'message'}">
                        <div class="message-header">
                            <div class="message-meta">
                                <span class="message-badge ${typeClass[msg.type] || 'message'}">${typeText[msg.type] || 'ğŸ’¬ ë©”ì‹œì§€'}</span>
                                <span class="message-sender">${msg.sender === 'dad' ? 'ğŸ‘¨ ì•„ë²„ì§€' : 'ğŸ‘§ ë‹¤ì˜'}</span>
                            </div>
                            <div class="message-actions"><button class="msg-action-btn delete" onclick="deleteMessage('${msg.id}')">ğŸ—‘ï¸</button></div>
                        </div>
                        <div class="message-content">${escapeHtml(msg.content)}</div>
                        <div class="message-time">${formatTime(new Date(msg.timestamp))}</div>
                    </div>`;
                });
                html += '</div>';
            });

            history.innerHTML = html;
        }

        async function deleteMessage(messageId) {
            try {
                const res = await fetch(API_URL, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messageId })
                });
                const data = await res.json();
                updateDisplay(data);
                showToast('ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ');
            } catch (e) {
                showToast('âŒ ì‚­ì œ ì‹¤íŒ¨');
            }
        }

        function updateTimeAgo() {
            if (lastUpdateTimestamp) {
                document.getElementById('lastUpdateAgo').textContent = formatTimeAgo(lastUpdateTimestamp);
            }
        }

        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function formatTime(date) { return date.toLocaleTimeString('ko-KR', { hour: 'numeric', minute: '2-digit', hour12: true }); }
        function formatFullDate(date) { return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' }); }
        function formatGroupDate(date) {
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            const dateStr = date.toISOString().split('T')[0];
            if (dateStr === today) return 'ì˜¤ëŠ˜';
            if (dateStr === yesterday) return 'ì–´ì œ';
            return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
        }
        function formatTimeAgo(date) {
            const diff = new Date() - date;
            const minutes = Math.floor(diff / 60000), hours = Math.floor(diff / 3600000), days = Math.floor(diff / 86400000);
            if (minutes < 1) return 'ë°©ê¸ˆ ì „';
            if (minutes < 60) return minutes + 'ë¶„ ì „';
            if (hours < 24) return hours + 'ì‹œê°„ ì „';
            if (days === 1) return 'ì–´ì œ';
            return days + 'ì¼ ì „';
        }
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
    </script>
</body>
</html>
