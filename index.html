<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¤ì˜ì´ ìƒíƒœ ì•Œë¦¼</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#6366F1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ë‹¤ì˜ì´ ìƒíƒœ">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <style>
        :root{--primary:#6366F1;--primary-light:#818CF8;--primary-dark:#4F46E5;--secondary:#EC4899;--success:#10B981;--warning:#F59E0B;--danger:#EF4444;--bg:#F8FAFC;--card:#FFFFFF;--text:#1E293B;--text-muted:#64748B;--border:#E2E8F0;--shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -2px rgba(0,0,0,0.1)}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:-apple-system,BlinkMacSystemFont,'Malgun Gothic','ë§‘ì€ ê³ ë”•',sans-serif;background:var(--bg);min-height:100vh;color:var(--text);line-height:1.6}
        .app{max-width:500px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
        .header{text-align:center;padding:16px;background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);color:white}
        .header h1{font-size:1.2rem;font-weight:700}
        .tab-nav{display:flex;background:white;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
        .tab-btn{flex:1;padding:12px 8px;border:none;background:white;font-size:0.85rem;font-weight:600;color:var(--text-muted);cursor:pointer;border-bottom:3px solid transparent}
        .tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}
        .tab-content{flex:1;display:none;padding:16px;overflow-y:auto}
        .tab-content.active{display:block}
        .status-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
        .status-card{background:white;border-radius:14px;padding:14px;text-align:center;box-shadow:var(--shadow);border:2px solid transparent}
        .status-card.location-going_home{border-color:#A5F3FC;background:linear-gradient(180deg,#ECFEFF,white)}
        .status-card.location-at_home{border-color:#BBF7D0;background:linear-gradient(180deg,#F0FDF4,white)}
        .status-card.location-outside{border-color:#FDE68A;background:linear-gradient(180deg,#FFFBEB,white)}
        .status-card.location-busy{border-color:#FECACA;background:linear-gradient(180deg,#FEF2F2,white)}
        .status-card.hunger-hungry{border-color:#FBCFE8;background:linear-gradient(180deg,#FDF2F8,white)}
        .status-card.hunger-not_hungry{border-color:#C7D2FE;background:linear-gradient(180deg,#EEF2FF,white)}
        .status-label{font-size:0.7rem;color:var(--text-muted);margin-bottom:4px}
        .status-emoji{font-size:2rem}
        .status-text{font-size:0.8rem;font-weight:600;margin-top:4px}
        .status-time{font-size:0.65rem;color:var(--text-muted);margin-top:2px}
        .section{background:white;border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:var(--shadow)}
        .section-title{font-size:0.9rem;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:6px}
        .input-group{margin-bottom:10px}
        .input-label{font-size:0.75rem;font-weight:600;margin-bottom:4px;display:block}
        .input-field{width:100%;padding:10px;border:2px solid var(--border);border-radius:10px;font-size:0.85rem;font-family:inherit;resize:none;min-height:50px}
        .input-field:focus{outline:none;border-color:var(--primary)}
        .btn{width:100%;padding:12px;border:none;border-radius:10px;font-size:0.9rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px}
        .btn:active{transform:scale(0.98)}
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white}
        .btn-pink{background:linear-gradient(135deg,#EC4899,#DB2777);color:white}
        .btn-outline{background:white;border:2px solid var(--border);color:var(--text)}
        .calendar{background:white;border-radius:14px;padding:14px;box-shadow:var(--shadow)}
        .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .calendar-title{font-size:1rem;font-weight:700}
        .calendar-nav{background:var(--bg);border:none;width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:1rem}
        .calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;margin-bottom:6px}
        .calendar-weekday{font-size:0.7rem;font-weight:600;color:var(--text-muted);padding:6px 0}
        .calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
        .calendar-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:8px;font-size:0.8rem;cursor:pointer;position:relative}
        .calendar-day:hover{background:var(--bg)}
        .calendar-day.other-month{opacity:0.3}
        .calendar-day.today{background:#EEF2FF;font-weight:700;color:var(--primary)}
        .calendar-day.selected{background:var(--primary);color:white}
        .calendar-day.has-data::after{content:'';position:absolute;bottom:3px;width:5px;height:5px;background:var(--secondary);border-radius:50%}
        .day-detail{margin-top:14px;background:white;border-radius:14px;padding:14px;box-shadow:var(--shadow)}
        .day-detail-title{font-size:0.95rem;font-weight:700;margin-bottom:10px}
        .day-entry{padding:10px;background:var(--bg);border-radius:8px;margin-bottom:8px;font-size:0.8rem}
        .day-entry-time{font-size:0.65rem;color:var(--text-muted)}
        .day-entry img{max-width:100%;border-radius:6px;margin-top:6px}
        .status-selector{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
        .status-option{padding:10px;border:2px solid var(--border);border-radius:10px;background:white;cursor:pointer;text-align:center}
        .status-option.selected{border-color:var(--primary);background:#EEF2FF}
        .status-option .emoji{font-size:1.3rem;display:block}
        .status-option .text{font-size:0.75rem;margin-top:2px}
        .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000;padding:20px}
        .modal-overlay.active{display:flex}
        .modal{background:white;padding:20px;border-radius:16px;width:100%;max-width:280px;text-align:center}
        .modal h3{font-size:1rem;margin-bottom:14px}
        .modal-input{width:100%;padding:12px;border:2px solid var(--border);border-radius:10px;font-size:1.2rem;text-align:center;letter-spacing:8px;margin-bottom:14px}
        .modal-input:focus{outline:none;border-color:var(--primary)}
        .modal-buttons{display:flex;gap:8px}
        .modal-buttons .btn{flex:1;padding:10px}
        .toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--text);color:white;padding:10px 20px;border-radius:10px;font-size:0.85rem;z-index:1000;transition:transform 0.3s}
        .toast.show{transform:translateX(-50%) translateY(0)}
        .push-banner{background:linear-gradient(135deg,var(--success),#059669);border-radius:10px;padding:10px 14px;margin-bottom:14px;color:white;display:flex;align-items:center;justify-content:space-between}
        .push-banner.hidden{display:none}
        .push-banner-text{font-size:0.8rem}
        .push-banner-btn{background:white;color:var(--success);border:none;padding:6px 12px;border-radius:6px;font-weight:600;font-size:0.75rem;cursor:pointer}
        .message-group{background:var(--bg);border-radius:10px;padding:10px;margin-bottom:8px}
        .message-group-time{font-size:0.65rem;color:var(--text-muted);margin-bottom:6px}
        .message-group-item{font-size:0.8rem;margin-bottom:4px;padding-left:14px;position:relative}
        .message-group-item::before{content:'';position:absolute;left:0;top:6px;width:6px;height:6px;border-radius:50%}
        .message-group-item.message::before{background:var(--primary)}
        .message-group-item.advice::before{background:var(--secondary)}
        .message-group-item.memo::before{background:var(--success)}
        .loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;height:100%}
        .loading-spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .photo-preview{max-width:100%;border-radius:10px;margin:10px 0}
    </style>
</head>
<body>
<div class="app">
    <header class="header">
        <h1>ğŸ’• ë‹¤ì˜ì´ ìƒíƒœ</h1>
    </header>
    <nav class="tab-nav">
        <button class="tab-btn active" data-tab="home">ğŸ  í™ˆ</button>
        <button class="tab-btn" data-tab="calendar">ğŸ“… ë‹¬ë ¥</button>
        <button class="tab-btn" data-tab="dayoung">ğŸ‘§ ë‹¤ì˜</button>
    </nav>
    <div id="loading" class="loading tab-content active">
        <div class="loading-spinner"></div>
        <p style="margin-top:12px;color:var(--text-muted);font-size:0.85rem">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
    <!-- í™ˆ íƒ­ -->
    <div id="tab-home" class="tab-content">
        <div id="pushBanner" class="push-banner hidden">
            <span class="push-banner-text">ğŸ”” ì•Œë¦¼ ë°›ê¸°</span>
            <button class="push-banner-btn" onclick="subscribePush()">í—ˆìš©</button>
        </div>
        <div class="status-grid">
            <div id="locationCard" class="status-card location-going_home">
                <div class="status-label">ğŸ“ ë‹¤ì˜ì´ ìœ„ì¹˜</div>
                <div id="locationEmoji" class="status-emoji">ğŸš¶</div>
                <div id="locationText" class="status-text">ì§‘ì— ê°€ëŠ” ì¤‘</div>
                <div id="locationTime" class="status-time"></div>
            </div>
            <div id="hungerCard" class="status-card hunger-not_hungry">
                <div class="status-label">ğŸš ë°°ê³ í””</div>
                <div id="hungerEmoji" class="status-emoji">ğŸ˜Š</div>
                <div id="hungerText" class="status-text">ì•ˆ ê³ íŒŒìš”</div>
                <div id="hungerTime" class="status-time"></div>
            </div>
        </div>
        <div class="section">
            <div class="section-title">ğŸ’¬ ì˜¤ëŠ˜ì˜ ë©”ì‹œì§€</div>
            <div id="todayMessages"><p style="color:var(--text-muted);font-size:0.8rem;text-align:center;padding:16px 0">ë©”ì‹œì§€ê°€ ì—†ì–´ìš”</p></div>
        </div>
        <div class="section">
            <div class="section-title">ğŸ‘¨ ì•„ë²„ì§€ ë©”ëª¨</div>
            <div class="input-group">
                <label class="input-label">ğŸ’¬ í•˜ê³ ì‹¶ì€ ë§</label>
                <textarea id="fatherMessage" class="input-field" placeholder="ë‹¤ì˜ì´ì—ê²Œ..."></textarea>
            </div>
            <div class="input-group">
                <label class="input-label">â¤ï¸ ë‹¹ë¶€</label>
                <textarea id="fatherAdvice" class="input-field" placeholder="ë‹¹ë¶€í•  ë§..."></textarea>
            </div>
            <div class="input-group">
                <label class="input-label">ğŸ“ ë©”ëª¨</label>
                <textarea id="fatherMemo" class="input-field" placeholder="ê¸°íƒ€ ë©”ëª¨..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveFatherMemo()">ğŸ’¾ í•œë²ˆì— ì €ì¥</button>
        </div>
    </div>
    <!-- ë‹¬ë ¥ íƒ­ -->
    <div id="tab-calendar" class="tab-content">
        <div class="calendar">
            <div class="calendar-header">
                <button class="calendar-nav" onclick="changeMonth(-1)">â—€</button>
                <div class="calendar-title" id="calendarTitle"></div>
                <button class="calendar-nav" onclick="changeMonth(1)">â–¶</button>
            </div>
            <div class="calendar-weekdays">
                <div class="calendar-weekday">ì¼</div>
                <div class="calendar-weekday">ì›”</div>
                <div class="calendar-weekday">í™”</div>
                <div class="calendar-weekday">ìˆ˜</div>
                <div class="calendar-weekday">ëª©</div>
                <div class="calendar-weekday">ê¸ˆ</div>
                <div class="calendar-weekday">í† </div>
            </div>
            <div class="calendar-days" id="calendarDays"></div>
        </div>
        <div id="dayDetail" class="day-detail" style="display:none">
            <div class="day-detail-title" id="dayDetailTitle"></div>
            <div id="dayEntries"></div>
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
                <textarea id="calendarMemo" class="input-field" placeholder="ì´ ë‚ ì˜ ë©”ëª¨..."></textarea>
                <input type="file" id="photoUpload" accept="image/*" onchange="previewPhoto(event)" style="display:none">
                <img id="photoPreview" class="photo-preview" style="display:none">
                <div style="display:flex;gap:8px;margin-top:10px">
                    <button class="btn btn-outline" onclick="document.getElementById('photoUpload').click()" style="flex:1">ğŸ“·</button>
                    <button class="btn btn-primary" onclick="saveCalendarEntry()" style="flex:2">ğŸ’¾ ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>
    <!-- ë‹¤ì˜ íƒ­ -->
    <div id="tab-dayoung" class="tab-content">
        <div id="dayoungLocked" style="text-align:center;padding:50px 20px">
            <div style="font-size:3.5rem;margin-bottom:14px">ğŸ”</div>
            <p style="color:var(--text-muted);margin-bottom:16px;font-size:0.85rem">ë‹¤ì˜ì´ ì „ìš© í™”ë©´</p>
            <button class="btn btn-pink" onclick="showPasswordModal()" style="max-width:180px;margin:0 auto">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</button>
        </div>
        <div id="dayoungUnlocked" style="display:none">
            <div class="section">
                <div class="section-title">ğŸ‘§ ë‚´ ìƒíƒœ ë³€ê²½</div>
                <div class="input-label">ğŸ“ ìœ„ì¹˜</div>
                <div class="status-selector" id="locationSelector">
                    <div class="status-option" data-value="going_home"><span class="emoji">ğŸš¶</span><span class="text">ì§‘ì— ê°€ëŠ” ì¤‘</span></div>
                    <div class="status-option" data-value="at_home"><span class="emoji">ğŸ </span><span class="text">ì§‘ ë„ì°©</span></div>
                    <div class="status-option" data-value="outside"><span class="emoji">ğŸŒ™</span><span class="text">ë°–ì—</span></div>
                    <div class="status-option" data-value="busy"><span class="emoji">ğŸ’¼</span><span class="text">ë°”ë¹ ìš”</span></div>
                </div>
                <div class="input-label">ğŸš ë°°ê³ í””</div>
                <div class="status-selector" id="hungerSelector">
                    <div class="status-option" data-value="not_hungry"><span class="emoji">ğŸ˜Š</span><span class="text">ì•ˆ ê³ íŒŒìš”</span></div>
                    <div class="status-option" data-value="hungry"><span class="emoji">ğŸ½ï¸</span><span class="text">ë°°ê³ íŒŒìš”</span></div>
                </div>
                <div class="input-group" style="margin-top:12px">
                    <label class="input-label">ğŸ’¬ ì•„ë²„ì§€ì—ê²Œ</label>
                    <textarea id="dayoungMessage" class="input-field" placeholder="ë©”ì‹œì§€..."></textarea>
                </div>
                <button class="btn btn-pink" onclick="saveDayoungStatus()">ğŸ’• ì €ì¥</button>
            </div>
        </div>
    </div>
</div>
<div id="passwordModal" class="modal-overlay">
    <div class="modal">
        <h3>ğŸ” ë¹„ë°€ë²ˆí˜¸</h3>
        <input type="password" id="passwordInput" class="modal-input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric">
        <div class="modal-buttons">
            <button class="btn btn-outline" onclick="closePasswordModal()">ì·¨ì†Œ</button>
            <button class="btn btn-pink" onclick="checkPassword()">í™•ì¸</button>
        </div>
    </div>
</div>
<div id="toast" class="toast"></div>
<script>
const API_URL='https://dayoung-api-v2-937334177552.asia-northeast3.run.app';
const VAPID_KEY='BMcQVh8osasMQwurhtnGOGEM9f2saQUA7t0JchYvqY03a3lITmeDVhlBd8YJhqT4hDsWiQtCqHfrGsQhGGMShGM';
const DAYOUNG_PW='2428';
let currentData={},selectedDate=null,currentMonth=new Date(),selectedLocation=null,selectedHunger=null,photoData=null;
const locMap={going_home:{e:'ğŸš¶',t:'ì§‘ì— ê°€ëŠ” ì¤‘'},at_home:{e:'ğŸ ',t:'ì§‘ ë„ì°©!'},outside:{e:'ğŸŒ™',t:'ë°–ì—'},busy:{e:'ğŸ’¼',t:'ë°”ë¹ ìš”'}};
const hunMap={not_hungry:{e:'ğŸ˜Š',t:'ì•ˆ ê³ íŒŒìš”'},hungry:{e:'ğŸ½ï¸',t:'ë°°ê³ íŒŒìš”'}};

document.addEventListener('DOMContentLoaded',()=>{
    initTabs();
    fetchData();
    initSelectors();
    registerSW();
    checkPush();
    renderCalendar();
});

function initTabs(){
    document.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.onclick=()=>{
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
        };
    });
}

function initSelectors(){
    document.querySelectorAll('#locationSelector .status-option').forEach(opt=>{
        opt.onclick=()=>{
            document.querySelectorAll('#locationSelector .status-option').forEach(o=>o.classList.remove('selected'));
            opt.classList.add('selected');
            selectedLocation=opt.dataset.value;
        };
    });
    document.querySelectorAll('#hungerSelector .status-option').forEach(opt=>{
        opt.onclick=()=>{
            document.querySelectorAll('#hungerSelector .status-option').forEach(o=>o.classList.remove('selected'));
            opt.classList.add('selected');
            selectedHunger=opt.dataset.value;
        };
    });
}

async function fetchData(){
    try{
        const res=await fetch(API_URL);
        currentData=await res.json();
        document.getElementById('loading').classList.remove('active');
        document.getElementById('tab-home').classList.add('active');
        updateDisplay();
    }catch(e){
        document.getElementById('loading').innerHTML='<p style="color:var(--danger)">ì—°ê²° ì‹¤íŒ¨</p>';
    }
}

function updateDisplay(){
    const loc=locMap[currentData.location]||locMap.going_home;
    document.getElementById('locationEmoji').textContent=loc.e;
    document.getElementById('locationText').textContent=loc.t;
    document.getElementById('locationCard').className='status-card location-'+(currentData.location||'going_home');
    if(currentData.locationUpdated)document.getElementById('locationTime').textContent=formatTime(currentData.locationUpdated);
    
    const hun=hunMap[currentData.hunger]||hunMap.not_hungry;
    document.getElementById('hungerEmoji').textContent=hun.e;
    document.getElementById('hungerText').textContent=hun.t;
    document.getElementById('hungerCard').className='status-card hunger-'+(currentData.hunger||'not_hungry');
    if(currentData.hungerUpdated)document.getElementById('hungerTime').textContent=formatTime(currentData.hungerUpdated);
    
    displayTodayMessages();
    renderCalendar();
}

function displayTodayMessages(){
    const container=document.getElementById('todayMessages');
    const today=new Date().toISOString().split('T')[0];
    const msgs=(currentData.messages||[]).filter(m=>m.timestamp&&m.timestamp.startsWith(today));
    
    if(!msgs.length){
        container.innerHTML='<p style="color:var(--text-muted);font-size:0.8rem;text-align:center;padding:16px 0">ì˜¤ëŠ˜ì˜ ë©”ì‹œì§€ê°€ ì—†ì–´ìš”</p>';
        return;
    }
    
    const grouped={};
    msgs.forEach(m=>{
        const time=m.timestamp.substring(11,16);
        if(!grouped[time])grouped[time]=[];
        grouped[time].push(m);
    });
    
    let html='';
    Object.keys(grouped).sort().reverse().forEach(time=>{
        html+=`<div class="message-group"><div class="message-group-time">${time}</div>`;
        grouped[time].forEach(m=>{
            const icon=m.sender==='dad'?'ğŸ‘¨':'ğŸ‘§';
            html+=`<div class="message-group-item ${m.type}">${icon} ${m.content}</div>`;
        });
        html+='</div>';
    });
    container.innerHTML=html;
}

async function saveFatherMemo(){
    const msg=document.getElementById('fatherMessage').value.trim();
    const adv=document.getElementById('fatherAdvice').value.trim();
    const memo=document.getElementById('fatherMemo').value.trim();
    if(!msg&&!adv&&!memo){showToast('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
    
    try{
        const body={};
        if(msg)body.fatherMessage=msg;
        if(adv)body.fatherAdvice=adv;
        if(memo)body.fatherMemo=memo;
        const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        currentData=await res.json();
        updateDisplay();
        document.getElementById('fatherMessage').value='';
        document.getElementById('fatherAdvice').value='';
        document.getElementById('fatherMemo').value='';
        showToast('âœ… ì €ì¥ ì™„ë£Œ!');
    }catch(e){showToast('âŒ ì €ì¥ ì‹¤íŒ¨');}
}

async function saveDayoungStatus(){
    const msg=document.getElementById('dayoungMessage').value.trim();
    if(!selectedLocation&&!selectedHunger&&!msg){showToast('ë³€ê²½í•  ë‚´ìš©ì„ ì„ íƒí•˜ì„¸ìš”');return;}
    
    try{
        const body={};
        if(selectedLocation)body.location=selectedLocation;
        if(selectedHunger)body.hunger=selectedHunger;
        if(msg)body.dayoungMessage=msg;
        const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        currentData=await res.json();
        updateDisplay();
        document.getElementById('dayoungMessage').value='';
        showToast('ğŸ’• ì €ì¥ ì™„ë£Œ!');
    }catch(e){showToast('âŒ ì €ì¥ ì‹¤íŒ¨');}
}

// ë‹¬ë ¥
function renderCalendar(){
    const year=currentMonth.getFullYear(),month=currentMonth.getMonth();
    document.getElementById('calendarTitle').textContent=`${year}ë…„ ${month+1}ì›”`;
    
    const firstDay=new Date(year,month,1).getDay();
    const lastDate=new Date(year,month+1,0).getDate();
    const today=new Date();
    const todayStr=today.toISOString().split('T')[0];
    
    const datesWithData=new Set();
    (currentData.messages||[]).forEach(m=>{
        if(m.timestamp)datesWithData.add(m.timestamp.split('T')[0]);
    });
    
    let html='';
    for(let i=0;i<firstDay;i++){
        const d=new Date(year,month,0-firstDay+i+1).getDate();
        html+=`<div class="calendar-day other-month">${d}</div>`;
    }
    for(let d=1;d<=lastDate;d++){
        const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isToday=dateStr===todayStr;
        const hasData=datesWithData.has(dateStr);
        const isSelected=selectedDate===dateStr;
        html+=`<div class="calendar-day${isToday?' today':''}${hasData?' has-data':''}${isSelected?' selected':''}" onclick="selectDate('${dateStr}')">${d}</div>`;
    }
    document.getElementById('calendarDays').innerHTML=html;
}

function changeMonth(delta){
    currentMonth.setMonth(currentMonth.getMonth()+delta);
    renderCalendar();
}

function selectDate(dateStr){
    selectedDate=dateStr;
    renderCalendar();
    showDayDetail(dateStr);
}

function showDayDetail(dateStr){
    const[y,m,d]=dateStr.split('-');
    document.getElementById('dayDetailTitle').textContent=`${parseInt(m)}ì›” ${parseInt(d)}ì¼ ê¸°ë¡`;
    document.getElementById('dayDetail').style.display='block';
    
    const entries=(currentData.messages||[]).filter(msg=>msg.timestamp&&msg.timestamp.startsWith(dateStr));
    const container=document.getElementById('dayEntries');
    
    if(!entries.length){
        container.innerHTML='<p style="color:var(--text-muted);font-size:0.8rem;text-align:center;padding:12px">ê¸°ë¡ì´ ì—†ì–´ìš”</p>';
    }else{
        container.innerHTML=entries.map(e=>{
            const time=e.timestamp.substring(11,16);
            const icon=e.sender==='dad'?'ğŸ‘¨':'ğŸ‘§';
            let content=`<div class="day-entry"><div class="day-entry-time">${time} ${icon}</div><div>${e.content}</div>`;
            if(e.photo)content+=`<img src="${e.photo}">`;
            content+='</div>';
            return content;
        }).join('');
    }
    
    document.getElementById('calendarMemo').value='';
    document.getElementById('photoPreview').style.display='none';
    photoData=null;
}

function previewPhoto(e){
    const file=e.target.files[0];
    if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
        photoData=ev.target.result;
        document.getElementById('photoPreview').src=photoData;
        document.getElementById('photoPreview').style.display='block';
    };
    reader.readAsDataURL(file);
}

async function saveCalendarEntry(){
    const memo=document.getElementById('calendarMemo').value.trim();
    if(!memo&&!photoData){showToast('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
    if(!selectedDate){showToast('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”');return;}
    
    try{
        const body={calendarEntry:{date:selectedDate,memo,photo:photoData}};
        const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        currentData=await res.json();
        showDayDetail(selectedDate);
        document.getElementById('calendarMemo').value='';
        document.getElementById('photoPreview').style.display='none';
        photoData=null;
        showToast('âœ… ì €ì¥ ì™„ë£Œ!');
    }catch(e){showToast('âŒ ì €ì¥ ì‹¤íŒ¨');}
}

// ë¹„ë°€ë²ˆí˜¸
function showPasswordModal(){
    document.getElementById('passwordModal').classList.add('active');
    document.getElementById('passwordInput').value='';
    document.getElementById('passwordInput').focus();
}
function closePasswordModal(){document.getElementById('passwordModal').classList.remove('active');}
function checkPassword(){
    if(document.getElementById('passwordInput').value===DAYOUNG_PW){
        closePasswordModal();
        document.getElementById('dayoungLocked').style.display='none';
        document.getElementById('dayoungUnlocked').style.display='block';
        showToast('ğŸ”“ ì ê¸ˆ í•´ì œ!');
    }else{
        showToast('âŒ ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼');
        document.getElementById('passwordInput').value='';
    }
}
document.getElementById('passwordInput').addEventListener('keypress',e=>{if(e.key==='Enter')checkPassword();});

// Push
async function registerSW(){if('serviceWorker'in navigator)await navigator.serviceWorker.register('./sw.js');}
async function checkPush(){
    if(!('PushManager'in window))return;
    const reg=await navigator.serviceWorker.ready;
    const sub=await reg.pushManager.getSubscription();
    document.getElementById('pushBanner').classList.toggle('hidden',!!sub);
}
async function subscribePush(){
    try{
        const perm=await Notification.requestPermission();
        if(perm!=='granted'){showToast('ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ë¨');return;}
        const reg=await navigator.serviceWorker.ready;
        const sub=await reg.pushManager.subscribe({userVisibleOnly:true,applicationServerKey:urlB64(VAPID_KEY)});
        await fetch(API_URL+'/subscribe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({subscription:sub.toJSON(),role:'dad'})});
        document.getElementById('pushBanner').classList.add('hidden');
        showToast('ğŸ”” ì•Œë¦¼ ë“±ë¡ ì™„ë£Œ!');
    }catch(e){showToast('ì•Œë¦¼ ë“±ë¡ ì‹¤íŒ¨');}
}
function urlB64(b64){const p='='.repeat((4-b64.length%4)%4);const b=(b64+p).replace(/-/g,'+').replace(/_/g,'/');return Uint8Array.from(atob(b),c=>c.charCodeAt(0));}

function formatTime(ts){
    const d=new Date(ts);
    const h=d.getHours(),m=d.getMinutes();
    return `${h<12?'ì˜¤ì „':'ì˜¤í›„'} ${h%12||12}:${String(m).padStart(2,'0')}`;
}
function showToast(msg){
    const t=document.getElementById('toast');
    t.textContent=msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'),2500);
}
</script>
</body>
</html>
