<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¤ì˜ì´ ìƒíƒœ ì•Œë¦¼</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#6366F1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ë‹¤ì˜ì´ ìƒíƒœ">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <style>
        :root {
            --primary: #6366F1;
            --primary-light: #A5B4FC;
            --primary-dark: #4F46E5;
            --secondary: #EC4899;
            --secondary-light: #F9A8D4;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg: linear-gradient(135deg, #F0F4FF 0%, #FCF0FF 50%, #FFF0F5 100%);
            --card: rgba(255, 255, 255, 0.85);
            --text: #1E293B;
            --text-muted: #64748B;
            --border: rgba(99, 102, 241, 0.15);
            --shadow: 0 8px 32px rgba(99, 102, 241, 0.12);
            --shadow-sm: 0 4px 12px rgba(99, 102, 241, 0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Malgun Gothic', sans-serif; background: var(--bg); background-attachment: fixed; min-height: 100vh; color: var(--text); line-height: 1.6; }
        .app { max-width: 500px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
        
        .header { text-align: center; padding: 20px 16px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; border-radius: 0 0 32px 32px; box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3); }
        .header h1 { font-size: 1.3rem; font-weight: 700; }
        
        .tab-nav { display: flex; background: var(--card); backdrop-filter: blur(20px); margin: -16px 16px 0; border-radius: 20px; padding: 6px; box-shadow: var(--shadow); position: relative; z-index: 100; }
        .tab-btn { flex: 1; padding: 12px 8px; border: none; background: transparent; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); cursor: pointer; border-radius: 16px; transition: all 0.3s ease; }
        .tab-btn.active { color: white; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        
        .tab-content { flex: 1; display: none; padding: 20px 16px; overflow-y: auto; }
        .tab-content.active { display: block; }
        
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .status-card { background: var(--card); backdrop-filter: blur(20px); border-radius: 24px; padding: 18px 14px; text-align: center; box-shadow: var(--shadow-sm); border: 2px solid transparent; transition: all 0.3s ease; }
        .status-card:active { transform: scale(0.98); }
        .status-card.location-going_home { border-color: #A5F3FC; background: linear-gradient(180deg, rgba(236,254,255,0.9), rgba(255,255,255,0.9)); }
        .status-card.location-at_home { border-color: #BBF7D0; background: linear-gradient(180deg, rgba(240,253,244,0.9), rgba(255,255,255,0.9)); }
        .status-card.location-outside { border-color: #FDE68A; background: linear-gradient(180deg, rgba(255,251,235,0.9), rgba(255,255,255,0.9)); }
        .status-card.location-busy { border-color: #FECACA; background: linear-gradient(180deg, rgba(254,242,242,0.9), rgba(255,255,255,0.9)); }
        .status-card.hunger-hungry { border-color: #FBCFE8; background: linear-gradient(180deg, rgba(253,242,248,0.9), rgba(255,255,255,0.9)); }
        .status-card.hunger-not_hungry { border-color: #C7D2FE; background: linear-gradient(180deg, rgba(238,242,255,0.9), rgba(255,255,255,0.9)); }
        .status-label { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 6px; font-weight: 500; }
        .status-emoji { font-size: 2.2rem; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1)); }
        .status-text { font-size: 0.85rem; font-weight: 700; margin-top: 6px; }
        .status-time { font-size: 0.65rem; color: var(--text-muted); margin-top: 4px; }
        
        .section { background: var(--card); backdrop-filter: blur(20px); border-radius: 24px; padding: 18px; margin-bottom: 16px; box-shadow: var(--shadow-sm); }
        .section-title { font-size: 0.95rem; font-weight: 700; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
        
        .input-group { margin-bottom: 12px; }
        .input-label { font-size: 0.8rem; font-weight: 600; margin-bottom: 6px; display: block; color: var(--text-muted); }
        .input-field { width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 16px; font-size: 0.9rem; font-family: inherit; resize: none; min-height: 56px; background: rgba(255,255,255,0.8); transition: all 0.3s ease; }
        .input-field:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 16px; font-size: 0.95rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .btn-pink { background: linear-gradient(135deg, #EC4899 0%, #DB2777 100%); color: white; box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4); }
        .btn-outline { background: white; border: 2px solid var(--border); color: var(--text); }
        .btn-success { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); color: white; }
        
        .calendar { background: var(--card); backdrop-filter: blur(20px); border-radius: 24px; padding: 18px; box-shadow: var(--shadow-sm); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .calendar-title { font-size: 1.1rem; font-weight: 700; }
        .calendar-nav { background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%); border: none; width: 36px; height: 36px; border-radius: 12px; cursor: pointer; font-size: 0.9rem; color: white; box-shadow: var(--shadow-sm); }
        .calendar-nav:active { transform: scale(0.95); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; margin-bottom: 8px; }
        .calendar-weekday { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); padding: 8px 0; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.85rem; cursor: pointer; position: relative; font-weight: 500; }
        .calendar-day:hover { background: rgba(99, 102, 241, 0.1); }
        .calendar-day.other-month { opacity: 0.3; }
        .calendar-day.today { background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%); font-weight: 700; color: var(--primary); box-shadow: inset 0 0 0 2px var(--primary); }
        .calendar-day.selected { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .calendar-day.has-data::after { content: ''; position: absolute; bottom: 4px; width: 6px; height: 6px; background: var(--secondary); border-radius: 50%; }
        
        .day-detail { margin-top: 16px; background: var(--card); backdrop-filter: blur(20px); border-radius: 24px; padding: 18px; box-shadow: var(--shadow-sm); }
        .day-detail-title { font-size: 1rem; font-weight: 700; margin-bottom: 14px; }
        
        /* ë©”ì‹œì§€ ì¹´ë“œ (ë¬¶ìŒ) */
        .message-card { background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%); border-radius: 20px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border); }
        .message-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px dashed var(--border); }
        .message-card-time { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; }
        .message-card-status { display: flex; align-items: center; gap: 6px; }
        .message-card-read { font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; font-weight: 600; }
        .message-card-read.read { background: #D1FAE5; color: #047857; }
        .message-card-read.unread { background: #FEE2E2; color: #B91C1C; }
        .message-card-delete { width: 28px; height: 28px; border: none; background: rgba(239, 68, 68, 0.1); border-radius: 8px; cursor: pointer; font-size: 0.8rem; color: var(--danger); }
        .message-card-delete:hover { background: var(--danger); color: white; }
        .message-card-item { display: flex; gap: 10px; margin-bottom: 10px; }
        .message-card-item:last-child { margin-bottom: 0; }
        .message-card-icon { width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; flex-shrink: 0; }
        .message-card-icon.message { background: #DBEAFE; }
        .message-card-icon.advice { background: #FCE7F3; }
        .message-card-icon.memo { background: #D1FAE5; }
        .message-card-content { flex: 1; font-size: 0.85rem; line-height: 1.5; }
        .message-card-label { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 2px; }
        
        /* ë‹¤ì˜ì´ ë©”ì‹œì§€ (ë‹¨ì¼) */
        .dayoung-message { background: linear-gradient(135deg, #FDF2F8 0%, #FCE7F3 100%); border-radius: 16px; padding: 14px; margin-bottom: 10px; border-left: 4px solid var(--secondary); }
        .dayoung-message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .dayoung-message-time { font-size: 0.7rem; color: var(--text-muted); }
        .dayoung-message-content { font-size: 0.85rem; }
        
        .status-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
        .status-option { padding: 14px 10px; border: 2px solid var(--border); border-radius: 16px; background: white; cursor: pointer; text-align: center; transition: all 0.3s ease; }
        .status-option:active { transform: scale(0.97); }
        .status-option.selected { border-color: var(--primary); background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); }
        .status-option .emoji { font-size: 1.6rem; display: block; }
        .status-option .text { font-size: 0.8rem; margin-top: 4px; font-weight: 600; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; padding: 28px 24px; border-radius: 28px; width: 100%; max-width: 300px; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .modal h3 { font-size: 1.1rem; margin-bottom: 20px; }
        .modal-input { width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; font-size: 1.5rem; text-align: center; letter-spacing: 12px; margin-bottom: 20px; font-weight: 700; }
        .modal-input:focus { outline: none; border-color: var(--primary); }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-buttons .btn { flex: 1; padding: 12px; }
        
        .toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(100px); background: linear-gradient(135deg, var(--text) 0%, #0F172A 100%); color: white; padding: 14px 28px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; z-index: 1000; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .install-btn { position: absolute; top: 12px; right: 12px; background: white; color: var(--primary); border: none; padding: 8px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        
        .push-banner { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); border-radius: 16px; padding: 14px 18px; margin-bottom: 16px; color: white; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .push-banner.hidden { display: none; }
        .push-banner-text { font-size: 0.85rem; font-weight: 600; }
        .push-banner-btn { background: white; color: var(--success); border: none; padding: 8px 16px; border-radius: 10px; font-weight: 700; font-size: 0.8rem; cursor: pointer; }
        
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 80px 20px; }
        .loading-spinner { width: 44px; height: 44px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .empty-state { text-align: center; padding: 32px 16px; color: var(--text-muted); font-size: 0.85rem; }
        .empty-state-emoji { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.5; }
        
        .photo-preview { max-width: 100%; border-radius: 16px; margin: 12px 0; box-shadow: var(--shadow-sm); }
        
        .unread-badge { background: var(--danger); color: white; font-size: 0.65rem; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-weight: 700; }
    </style>
</head>
<body>
<div class="app">
    <header class="header">
        <button id="installBtn" class="install-btn" style="display:none" onclick="installApp()">ğŸ“² ì•± ì„¤ì¹˜</button>
        <h1>ğŸ’• ë‹¤ì˜ì´ ìƒíƒœ</h1>
    </header>
    
    <nav class="tab-nav">
        <button class="tab-btn active" data-tab="home">ğŸ  í™ˆ</button>
        <button class="tab-btn" data-tab="calendar">ğŸ“… ë‹¬ë ¥</button>
        <button class="tab-btn" data-tab="dayoung">ğŸ‘§ ë‹¤ì˜</button>
    </nav>
    
    <div id="loading" class="loading tab-content active">
        <div class="loading-spinner"></div>
        <p style="margin-top:16px;color:var(--text-muted);font-size:0.9rem">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
    
    <!-- í™ˆ íƒ­ -->
    <div id="tab-home" class="tab-content">
        <div id="pushBanner" class="push-banner hidden">
            <span class="push-banner-text">ğŸ”” ì•Œë¦¼ ë°›ê¸°</span>
            <button class="push-banner-btn" onclick="subscribePush()">í—ˆìš©</button>
        </div>
        
        <div class="status-grid">
            <div id="locationCard" class="status-card location-going_home">
                <div class="status-label">ğŸ“ ë‹¤ì˜ì´ ìœ„ì¹˜</div>
                <div id="locationEmoji" class="status-emoji">ğŸš¶</div>
                <div id="locationText" class="status-text">ì§‘ì— ê°€ëŠ” ì¤‘</div>
                <div id="locationTime" class="status-time"></div>
            </div>
            <div id="hungerCard" class="status-card hunger-not_hungry">
                <div class="status-label">ğŸš ë°°ê³ í””</div>
                <div id="hungerEmoji" class="status-emoji">ğŸ˜Š</div>
                <div id="hungerText" class="status-text">ì•ˆ ê³ íŒŒìš”</div>
                <div id="hungerTime" class="status-time"></div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">ğŸ’¬ ì˜¤ëŠ˜ì˜ ë©”ì‹œì§€ <span id="unreadBadge" class="unread-badge" style="display:none"></span></div>
            <div id="todayMessages">
                <div class="empty-state">
                    <div class="empty-state-emoji">ğŸ’­</div>
                    <p>ì˜¤ëŠ˜ì˜ ë©”ì‹œì§€ê°€ ì—†ì–´ìš”</p>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">ğŸ‘¨ ì•„ë²„ì§€ ë©”ëª¨ ì‘ì„±</div>
            <div class="input-group">
                <label class="input-label">ğŸ’¬ í•˜ê³ ì‹¶ì€ ë§</label>
                <textarea id="fatherMessage" class="input-field" placeholder="ë‹¤ì˜ì´ì—ê²Œ í•˜ê³ ì‹¶ì€ ë§..."></textarea>
            </div>
            <div class="input-group">
                <label class="input-label">â¤ï¸ ë‹¹ë¶€</label>
                <textarea id="fatherAdvice" class="input-field" placeholder="ë‹¹ë¶€í•  ë§..."></textarea>
            </div>
            <div class="input-group">
                <label class="input-label">ğŸ“ ë©”ëª¨</label>
                <textarea id="fatherMemo" class="input-field" placeholder="ê¸°íƒ€ ë©”ëª¨..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveFatherMemo()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
    </div>
    
    <!-- ë‹¬ë ¥ íƒ­ -->
    <div id="tab-calendar" class="tab-content">
        <div class="calendar">
            <div class="calendar-header">
                <button class="calendar-nav" onclick="changeMonth(-1)">â—€</button>
                <div class="calendar-title" id="calendarTitle"></div>
                <button class="calendar-nav" onclick="changeMonth(1)">â–¶</button>
            </div>
            <div class="calendar-weekdays">
                <div class="calendar-weekday">ì¼</div>
                <div class="calendar-weekday">ì›”</div>
                <div class="calendar-weekday">í™”</div>
                <div class="calendar-weekday">ìˆ˜</div>
                <div class="calendar-weekday">ëª©</div>
                <div class="calendar-weekday">ê¸ˆ</div>
                <div class="calendar-weekday">í† </div>
            </div>
            <div class="calendar-days" id="calendarDays"></div>
        </div>
        <div id="dayDetail" class="day-detail" style="display:none">
            <div class="day-detail-title" id="dayDetailTitle"></div>
            <div id="dayEntries"></div>
            <div style="margin-top:16px;padding-top:16px;border-top:2px solid var(--border)">
                <textarea id="calendarMemo" class="input-field" placeholder="ì´ ë‚ ì˜ ë©”ëª¨ ì¶”ê°€..."></textarea>
                <input type="file" id="photoUpload" accept="image/*" onchange="previewPhoto(event)" style="display:none">
                <img id="photoPreview" class="photo-preview" style="display:none">
                <div style="display:flex;gap:10px;margin-top:12px">
                    <button class="btn btn-outline" onclick="document.getElementById('photoUpload').click()" style="flex:1">ğŸ“· ì‚¬ì§„</button>
                    <button class="btn btn-primary" onclick="saveCalendarEntry()" style="flex:2">ğŸ’¾ ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ë‹¤ì˜ íƒ­ -->
    <div id="tab-dayoung" class="tab-content">
        <div id="dayoungLocked" style="text-align:center;padding:60px 20px">
            <div style="font-size:4rem;margin-bottom:16px">ğŸ”</div>
            <p style="color:var(--text-muted);margin-bottom:20px;font-size:0.9rem">ë‹¤ì˜ì´ ì „ìš© í™”ë©´ì´ì—ìš”</p>
            <button class="btn btn-pink" onclick="showPasswordModal()" style="max-width:200px;margin:0 auto">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</button>
        </div>
        <div id="dayoungUnlocked" style="display:none">
            <!-- ì•Œë¦¼ ë“±ë¡ ë°°ë„ˆ -->
            <div id="dayoungPushBanner" class="push-banner hidden" style="background:linear-gradient(135deg,#EC4899,#DB2777)">
                <span class="push-banner-text">ğŸ”” ì•„ë²„ì§€ ë©”ì‹œì§€ ì•Œë¦¼ ë°›ê¸°</span>
                <button class="push-banner-btn" style="color:#DB2777" onclick="subscribePushDayoung()">í—ˆìš©</button>
            </div>
            <!-- ì•ˆì½ì€ ë©”ì‹œì§€ í‘œì‹œ -->
            <div id="unreadSection" class="section" style="display:none;border:2px solid var(--danger)">
                <div class="section-title" style="color:var(--danger)">ğŸ“¬ ì•ˆì½ì€ ì•„ë²„ì§€ ë©”ì‹œì§€</div>
                <div id="unreadMessages"></div>
                <button class="btn btn-success" onclick="markAllRead()" style="margin-top:12px">âœ“ ëª¨ë‘ ì½ìŒ í‘œì‹œ</button>
            </div>
            
            <div class="section">
                <div class="section-title">ğŸ‘§ ë‚´ ìƒíƒœ ë³€ê²½</div>
                <div class="input-label">ğŸ“ ì§€ê¸ˆ ì–´ë””ì— ìˆì–´ìš”?</div>
                <div class="status-selector" id="locationSelector">
                    <div class="status-option" data-value="going_home"><span class="emoji">ğŸš¶</span><span class="text">ì§‘ì— ê°€ëŠ” ì¤‘</span></div>
                    <div class="status-option" data-value="at_home"><span class="emoji">ğŸ </span><span class="text">ì§‘ ë„ì°©!</span></div>
                    <div class="status-option" data-value="outside"><span class="emoji">ğŸŒ™</span><span class="text">ë°–ì— ìˆì–´ìš”</span></div>
                    <div class="status-option" data-value="busy"><span class="emoji">ğŸ’¼</span><span class="text">ë°”ë¹ ìš”</span></div>
                </div>
                <div class="input-label">ğŸš ë°°ê³ íŒŒìš”?</div>
                <div class="status-selector" id="hungerSelector">
                    <div class="status-option" data-value="not_hungry"><span class="emoji">ğŸ˜Š</span><span class="text">ì•ˆ ê³ íŒŒìš”</span></div>
                    <div class="status-option" data-value="hungry"><span class="emoji">ğŸ½ï¸</span><span class="text">ë°°ê³ íŒŒìš”!</span></div>
                </div>
                <div class="input-group" style="margin-top:14px">
                    <label class="input-label">ğŸ’¬ ì•„ë²„ì§€ì—ê²Œ ë©”ì‹œì§€</label>
                    <textarea id="dayoungMessage" class="input-field" placeholder="ì•„ë²„ì§€ì—ê²Œ í•˜ê³  ì‹¶ì€ ë§..."></textarea>
                </div>
                <button class="btn btn-pink" onclick="saveDayoungStatus()">ğŸ’• ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<div id="passwordModal" class="modal-overlay">
    <div class="modal">
        <h3>ğŸ” ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
        <input type="password" id="passwordInput" class="modal-input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric">
        <div class="modal-buttons">
            <button class="btn btn-outline" onclick="closePasswordModal()">ì·¨ì†Œ</button>
            <button class="btn btn-pink" onclick="checkPassword()">í™•ì¸</button>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
const API_URL='https://dayoung-api-v2-937334177552.asia-northeast3.run.app';
const VAPID_KEY='BMcQVh8osasMQwurhtnGOGEM9f2saQUA7t0JchYvqY03a3lITmeDVhlBd8YJhqT4hDsWiQtCqHfrGsQhGGMShGM';
const DAYOUNG_PW='2428';

let currentData={}, selectedDate=null, currentMonth=new Date();
let selectedLocation=null, selectedHunger=null, photoData=null;

const locMap = {going_home:{e:'ğŸš¶',t:'ì§‘ì— ê°€ëŠ” ì¤‘'},at_home:{e:'ğŸ ',t:'ì§‘ ë„ì°©!'},outside:{e:'ğŸŒ™',t:'ë°–ì— ìˆì–´ìš”'},busy:{e:'ğŸ’¼',t:'ë°”ë¹ ìš”'}};
const hunMap = {not_hungry:{e:'ğŸ˜Š',t:'ì•ˆ ê³ íŒŒìš”'},hungry:{e:'ğŸ½ï¸',t:'ë°°ê³ íŒŒìš”'}};

let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installBtn').style.display = 'block';
});

async function installApp() {
    if (!deferredPrompt) {
        showToast('ë¸Œë¼ìš°ì € ë©”ë‰´ì—ì„œ "í™ˆ í™”ë©´ì— ì¶”ê°€"ë¥¼ ì„ íƒí•˜ì„¸ìš”');
        return;
    }
    deferredPrompt.prompt();
    const result = await deferredPrompt.userChoice;
    if (result.outcome === 'accepted') {
        showToast('ğŸ“² ì•± ì„¤ì¹˜ ì™„ë£Œ!');
    }
    deferredPrompt = null;
    document.getElementById('installBtn').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', () => {
    initTabs();
    fetchData();
    initSelectors();
    registerSW();
    checkPush();
    renderCalendar();
});

function initTabs() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        };
    });
}

function initSelectors() {
    document.querySelectorAll('#locationSelector .status-option').forEach(opt => {
        opt.onclick = () => {
            document.querySelectorAll('#locationSelector .status-option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            selectedLocation = opt.dataset.value;
        };
    });
    document.querySelectorAll('#hungerSelector .status-option').forEach(opt => {
        opt.onclick = () => {
            document.querySelectorAll('#hungerSelector .status-option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            selectedHunger = opt.dataset.value;
        };
    });
}

async function fetchData() {
    try {
        const res = await fetch(API_URL);
        currentData = await res.json();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('tab-home').classList.add('active');
        updateDisplay();
    } catch(e) {
        document.getElementById('loading').innerHTML = '<div class="empty-state"><div class="empty-state-emoji">ğŸ˜¢</div><p>ì—°ê²°í•  ìˆ˜ ì—†ì–´ìš”</p></div>';
    }
}

function updateDisplay() {
    const loc = locMap[currentData.location] || locMap.going_home;
    document.getElementById('locationEmoji').textContent = loc.e;
    document.getElementById('locationText').textContent = loc.t;
    document.getElementById('locationCard').className = 'status-card location-' + (currentData.location || 'going_home');
    if(currentData.locationUpdated) document.getElementById('locationTime').textContent = formatTime(currentData.locationUpdated);
    
    const hun = hunMap[currentData.hunger] || hunMap.not_hungry;
    document.getElementById('hungerEmoji').textContent = hun.e;
    document.getElementById('hungerText').textContent = hun.t;
    document.getElementById('hungerCard').className = 'status-card hunger-' + (currentData.hunger || 'not_hungry');
    if(currentData.hungerUpdated) document.getElementById('hungerTime').textContent = formatTime(currentData.hungerUpdated);
    
    displayTodayMessages();
    displayUnreadMessages();
    renderCalendar();
}

function displayTodayMessages() {
    const container = document.getElementById('todayMessages');
    const today = new Date().toISOString().split('T')[0];
    const msgs = (currentData.messages || []).filter(m => m.timestamp && m.timestamp.startsWith(today) && m.type !== 'calendar');
    
    if(!msgs.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-emoji">ğŸ’­</div><p>ì˜¤ëŠ˜ì˜ ë©”ì‹œì§€ê°€ ì—†ì–´ìš”</p></div>';
        document.getElementById('unreadBadge').style.display = 'none';
        return;
    }
    
    // ì‹œê°„ë³„ë¡œ ê·¸ë£¹í™” (ê°™ì€ ë¶„ì— ì €ì¥ëœ ì•„ë²„ì§€ ë©”ì‹œì§€ëŠ” ë¬¶ìŒ)
    const grouped = {};
    msgs.forEach(m => {
        const timeKey = m.timestamp.substring(0, 16); // YYYY-MM-DDTHH:MM
        const key = m.sender + '_' + timeKey;
        if(!grouped[key]) grouped[key] = { sender: m.sender, time: timeKey, items: [], ids: [], read: true };
        grouped[key].items.push(m);
        grouped[key].ids.push(m.id);
        if(m.sender === 'dad' && !m.read) grouped[key].read = false;
    });
    
    // ì•ˆì½ì€ ë©”ì‹œì§€ ì¹´ìš´íŠ¸
    const unreadCount = Object.values(grouped).filter(g => g.sender === 'dad' && !g.read).length;
    const badge = document.getElementById('unreadBadge');
    if(unreadCount > 0) {
        badge.textContent = unreadCount + 'ê°œ ì•ˆì½ìŒ';
        badge.style.display = 'inline';
    } else {
        badge.style.display = 'none';
    }
    
    let html = '';
    Object.values(grouped).sort((a,b) => new Date(b.time) - new Date(a.time)).forEach(g => {
        const time = g.time.substring(11, 16);
        
        if(g.sender === 'dad') {
            // ì•„ë²„ì§€ ë©”ì‹œì§€ ì¹´ë“œ (ë¬¶ìŒ)
            html += `<div class="message-card">
                <div class="message-card-header">
                    <span class="message-card-time">ğŸ‘¨ ${time}</span>
                    <div class="message-card-status">
                        <span class="message-card-read ${g.read ? 'read' : 'unread'}">${g.read ? 'âœ“ ì½ìŒ' : 'ì•ˆì½ìŒ'}</span>
                        <button class="message-card-delete" onclick="deleteMessages('${g.ids.join(',')}')">ğŸ—‘ï¸</button>
                    </div>
                </div>`;
            
            g.items.forEach(item => {
                const iconClass = item.type || 'message';
                const icons = {message: 'ğŸ’¬', advice: 'â¤ï¸', memo: 'ğŸ“'};
                const labels = {message: 'í•˜ê³ ì‹¶ì€ ë§', advice: 'ë‹¹ë¶€', memo: 'ë©”ëª¨'};
                html += `<div class="message-card-item">
                    <div class="message-card-icon ${iconClass}">${icons[iconClass] || 'ğŸ’¬'}</div>
                    <div class="message-card-content">
                        <div class="message-card-label">${labels[iconClass] || 'ë©”ì‹œì§€'}</div>
                        ${item.content}
                    </div>
                </div>`;
            });
            html += `</div>`;
        } else {
            // ë‹¤ì˜ì´ ë©”ì‹œì§€
            g.items.forEach(item => {
                html += `<div class="dayoung-message">
                    <div class="dayoung-message-header">
                        <span class="dayoung-message-time">ğŸ‘§ ${time}</span>
                        <button class="message-card-delete" onclick="deleteMessage('${item.id}')">ğŸ—‘ï¸</button>
                    </div>
                    <div class="dayoung-message-content">${item.content}</div>
                </div>`;
            });
        }
    });
    
    container.innerHTML = html;
}

function displayUnreadMessages() {
    const section = document.getElementById('unreadSection');
    const container = document.getElementById('unreadMessages');
    const unread = (currentData.messages || []).filter(m => m.sender === 'dad' && !m.read);
    
    if(!unread.length) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    
    // ì‹œê°„ë³„ ê·¸ë£¹í™”
    const grouped = {};
    unread.forEach(m => {
        const timeKey = m.timestamp.substring(0, 16);
        if(!grouped[timeKey]) grouped[timeKey] = [];
        grouped[timeKey].push(m);
    });
    
    let html = '';
    Object.keys(grouped).sort().reverse().forEach(timeKey => {
        const time = timeKey.substring(11, 16);
        const date = timeKey.substring(5, 10).replace('-', '/');
        html += `<div class="message-card" style="border:1px solid var(--danger)">
            <div class="message-card-header">
                <span class="message-card-time">ğŸ‘¨ ${date} ${time}</span>
            </div>`;
        grouped[timeKey].forEach(item => {
            const icons = {message: 'ğŸ’¬', advice: 'â¤ï¸', memo: 'ğŸ“'};
            const labels = {message: 'í•˜ê³ ì‹¶ì€ ë§', advice: 'ë‹¹ë¶€', memo: 'ë©”ëª¨'};
            html += `<div class="message-card-item">
                <div class="message-card-icon ${item.type}">${icons[item.type] || 'ğŸ’¬'}</div>
                <div class="message-card-content">
                    <div class="message-card-label">${labels[item.type] || 'ë©”ì‹œì§€'}</div>
                    ${item.content}
                </div>
            </div>`;
        });
        html += '</div>';
    });
    
    container.innerHTML = html;
}

async function markAllRead() {
    const unreadIds = (currentData.messages || []).filter(m => m.sender === 'dad' && !m.read).map(m => m.id);
    if(!unreadIds.length) return;
    
    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ markRead: unreadIds })
        });
        currentData = await res.json();
        updateDisplay();
        showToast('âœ“ ëª¨ë‘ ì½ìŒ í‘œì‹œ ì™„ë£Œ');
    } catch(e) {
        showToast('âŒ ì‹¤íŒ¨');
    }
}

async function deleteMessage(id) {
    if(!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
    try {
        const res = await fetch(API_URL, {method:'DELETE', headers:{'Content-Type':'application/json'}, body:JSON.stringify({messageId:id})});
        currentData = await res.json();
        updateDisplay();
        showToast('ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ');
    } catch(e) { showToast('âŒ ì‚­ì œ ì‹¤íŒ¨'); }
}

async function deleteMessages(ids) {
    if(!confirm('ì´ ë©”ì‹œì§€ë“¤ì„ ì‚­ì œí• ê¹Œìš”?')) return;
    try {
        for(const id of ids.split(',')) {
            await fetch(API_URL, {method:'DELETE', headers:{'Content-Type':'application/json'}, body:JSON.stringify({messageId:id})});
        }
        const res = await fetch(API_URL);
        currentData = await res.json();
        updateDisplay();
        showToast('ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ');
    } catch(e) { showToast('âŒ ì‚­ì œ ì‹¤íŒ¨'); }
}

async function saveFatherMemo() {
    const msg = document.getElementById('fatherMessage').value.trim();
    const adv = document.getElementById('fatherAdvice').value.trim();
    const memo = document.getElementById('fatherMemo').value.trim();
    if(!msg && !adv && !memo) { showToast('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
    
    try {
        const body = {};
        if(msg) body.fatherMessage = msg;
        if(adv) body.fatherAdvice = adv;
        if(memo) body.fatherMemo = memo;
        const res = await fetch(API_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        currentData = await res.json();
        updateDisplay();
        document.getElementById('fatherMessage').value = '';
        document.getElementById('fatherAdvice').value = '';
        document.getElementById('fatherMemo').value = '';
        showToast('âœ… ì €ì¥ ì™„ë£Œ!');
    } catch(e) { showToast('âŒ ì €ì¥ ì‹¤íŒ¨'); }
}

async function saveDayoungStatus() {
    const msg = document.getElementById('dayoungMessage').value.trim();
    if(!selectedLocation && !selectedHunger && !msg) { showToast('ë³€ê²½í•  ë‚´ìš©ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
    
    try {
        const body = {};
        if(selectedLocation) body.location = selectedLocation;
        if(selectedHunger) body.hunger = selectedHunger;
        if(msg) body.dayoungMessage = msg;
        const res = await fetch(API_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        currentData = await res.json();
        updateDisplay();
        document.getElementById('dayoungMessage').value = '';
        showToast('ğŸ’• ì €ì¥ ì™„ë£Œ!');
    } catch(e) { showToast('âŒ ì €ì¥ ì‹¤íŒ¨'); }
}

// ë‹¬ë ¥
function renderCalendar() {
    const year = currentMonth.getFullYear(), month = currentMonth.getMonth();
    document.getElementById('calendarTitle').textContent = `${year}ë…„ ${month + 1}ì›”`;
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();
    const todayStr = new Date().toISOString().split('T')[0];
    const datesWithData = new Set();
    (currentData.messages || []).forEach(m => { if(m.timestamp) datesWithData.add(m.timestamp.split('T')[0]); });
    
    let html = '';
    for(let i = 0; i < firstDay; i++) {
        const d = new Date(year, month, 0 - firstDay + i + 1).getDate();
        html += `<div class="calendar-day other-month">${d}</div>`;
    }
    for(let d = 1; d <= lastDate; d++) {
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isToday = dateStr === todayStr;
        const hasData = datesWithData.has(dateStr);
        const isSelected = selectedDate === dateStr;
        html += `<div class="calendar-day${isToday?' today':''}${hasData?' has-data':''}${isSelected?' selected':''}" onclick="selectDate('${dateStr}')">${d}</div>`;
    }
    document.getElementById('calendarDays').innerHTML = html;
}

function changeMonth(delta) { currentMonth.setMonth(currentMonth.getMonth() + delta); renderCalendar(); }

function selectDate(dateStr) { selectedDate = dateStr; renderCalendar(); showDayDetail(dateStr); }

function showDayDetail(dateStr) {
    const [y, m, d] = dateStr.split('-');
    document.getElementById('dayDetailTitle').textContent = `ğŸ“… ${parseInt(m)}ì›” ${parseInt(d)}ì¼ ê¸°ë¡`;
    document.getElementById('dayDetail').style.display = 'block';
    
    const entries = (currentData.messages || []).filter(msg => msg.timestamp && msg.timestamp.startsWith(dateStr));
    const container = document.getElementById('dayEntries');
    
    if(!entries.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-emoji">ğŸ“</div><p>ì´ ë‚ ì˜ ê¸°ë¡ì´ ì—†ì–´ìš”</p></div>';
    } else {
        // ì‹œê°„ë³„ ê·¸ë£¹í™”
        const grouped = {};
        entries.forEach(m => {
            const timeKey = m.timestamp.substring(0, 16);
            const key = m.sender + '_' + timeKey;
            if(!grouped[key]) grouped[key] = { sender: m.sender, time: timeKey, items: [], ids: [] };
            grouped[key].items.push(m);
            grouped[key].ids.push(m.id);
        });
        
        let html = '';
        Object.values(grouped).sort((a,b) => new Date(b.time) - new Date(a.time)).forEach(g => {
            const time = g.time.substring(11, 16);
            if(g.sender === 'dad') {
                html += `<div class="message-card">
                    <div class="message-card-header">
                        <span class="message-card-time">ğŸ‘¨ ${time}</span>
                        <button class="message-card-delete" onclick="deleteMessages('${g.ids.join(',')}')">ğŸ—‘ï¸</button>
                    </div>`;
                g.items.forEach(item => {
                    const icons = {message:'ğŸ’¬', advice:'â¤ï¸', memo:'ğŸ“', calendar:'ğŸ“…'};
                    html += `<div class="message-card-item">
                        <div class="message-card-icon ${item.type}">${icons[item.type]||'ğŸ’¬'}</div>
                        <div class="message-card-content">${item.content}</div>
                    </div>`;
                    if(item.photo) html += `<img src="${item.photo}" style="max-width:100%;border-radius:12px;margin-top:8px">`;
                });
                html += '</div>';
            } else {
                g.items.forEach(item => {
                    html += `<div class="dayoung-message">
                        <div class="dayoung-message-header">
                            <span class="dayoung-message-time">ğŸ‘§ ${time}</span>
                            <button class="message-card-delete" onclick="deleteMessage('${item.id}')">ğŸ—‘ï¸</button>
                        </div>
                        <div class="dayoung-message-content">${item.content}</div>
                    </div>`;
                });
            }
        });
        container.innerHTML = html;
    }
    
    document.getElementById('calendarMemo').value = '';
    document.getElementById('photoPreview').style.display = 'none';
    photoData = null;
}

function previewPhoto(e) {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        photoData = ev.target.result;
        document.getElementById('photoPreview').src = photoData;
        document.getElementById('photoPreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
}

async function saveCalendarEntry() {
    const memo = document.getElementById('calendarMemo').value.trim();
    if(!memo && !photoData) { showToast('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
    if(!selectedDate) { showToast('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
    
    try {
        const body = {calendarEntry: {date: selectedDate, memo, photo: photoData}};
        const res = await fetch(API_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        currentData = await res.json();
        showDayDetail(selectedDate);
        renderCalendar();
        document.getElementById('calendarMemo').value = '';
        document.getElementById('photoPreview').style.display = 'none';
        photoData = null;
        showToast('âœ… ì €ì¥ ì™„ë£Œ!');
    } catch(e) { showToast('âŒ ì €ì¥ ì‹¤íŒ¨'); }
}

function showPasswordModal() {
    document.getElementById('passwordModal').classList.add('active');
    document.getElementById('passwordInput').value = '';
    setTimeout(() => document.getElementById('passwordInput').focus(), 100);
}
function closePasswordModal() { document.getElementById('passwordModal').classList.remove('active'); }
function checkPassword() {
    if(document.getElementById('passwordInput').value === DAYOUNG_PW) {
        closePasswordModal();
        document.getElementById('dayoungLocked').style.display = 'none';
        document.getElementById('dayoungUnlocked').style.display = 'block';
        showToast('ğŸ”“ ì ê¸ˆ í•´ì œ!');        checkDayoungPush();
    } else {
        showToast('âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´ìš”');
        document.getElementById('passwordInput').value = '';
    }
}
document.getElementById('passwordInput').addEventListener('keypress', e => { if(e.key === 'Enter') checkPassword(); });

async function registerSW() { if('serviceWorker' in navigator) await navigator.serviceWorker.register('./sw.js'); }
async function checkDayoungPush() {
    if(!("PushManager" in window)) return;
    const reg = await navigator.serviceWorker.ready;
    const sub = await reg.pushManager.getSubscription();
    document.getElementById("dayoungPushBanner").classList.toggle("hidden", !!sub);
}

async function checkPush() {
    if(!('PushManager' in window)) return;
    const reg = await navigator.serviceWorker.ready;
    const sub = await reg.pushManager.getSubscription();
    document.getElementById('pushBanner').classList.toggle('hidden', !!sub);
}
async function subscribePushDayoung() {
    try {
        const perm = await Notification.requestPermission();
        if(perm !== "granted") { showToast("ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë¨"); return; }
        const reg = await navigator.serviceWorker.ready;
        const sub = await reg.pushManager.subscribe({userVisibleOnly:true, applicationServerKey:urlB64(VAPID_KEY)});
        await fetch(API_URL + "/subscribe", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({subscription:sub.toJSON(), role:"dayoung"})});
        document.getElementById("dayoungPushBanner").classList.add("hidden");
        showToast("ğŸ”” ì•Œë¦¼ ë“±ë¡ ì™„ë£Œ!");
    } catch(e) { showToast("ì•Œë¦¼ ë“±ë¡ ì‹¤íŒ¨"); }
}

async function subscribePush() {
    try {
        const perm = await Notification.requestPermission();
        if(perm !== 'granted') { showToast('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë¨'); return; }
        const reg = await navigator.serviceWorker.ready;
        const sub = await reg.pushManager.subscribe({userVisibleOnly:true, applicationServerKey:urlB64(VAPID_KEY)});
        await fetch(API_URL + '/subscribe', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({subscription:sub.toJSON(), role:'dad'})});
        document.getElementById('pushBanner').classList.add('hidden');
        showToast('ğŸ”” ì•Œë¦¼ ë“±ë¡ ì™„ë£Œ!');
    } catch(e) { showToast('ì•Œë¦¼ ë“±ë¡ ì‹¤íŒ¨'); }
}
function urlB64(b64) { const p='='.repeat((4-b64.length%4)%4); const b=(b64+p).replace(/-/g,'+').replace(/_/g,'/'); return Uint8Array.from(atob(b),c=>c.charCodeAt(0)); }

function formatTime(ts) {
    const d = new Date(ts);
    return `${d.getHours() < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„'} ${d.getHours() % 12 || 12}:${String(d.getMinutes()).padStart(2, '0')}`;
}
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}
</script>
</body>
</html>
