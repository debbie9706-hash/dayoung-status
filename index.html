<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>ë‹¤ì˜ì´ ìƒíƒœ ì•Œë¦¼</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#5B8A72">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ë‹¤ì˜ì´ ìƒíƒœ">
    <link rel="apple-touch-icon" href="./icon-192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
            background: #F5F1EB;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }

        .container {
            background: white;
            border-radius: 28px;
            padding: 28px 24px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header-emoji {
            font-size: 3em;
            margin-bottom: 8px;
        }

        h1 {
            color: #2D3436;
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .subtitle {
            color: #636E72;
            font-size: 1em;
            line-height: 1.5;
        }

        .last-update-banner {
            background: linear-gradient(135deg, #74B9FF 0%, #0984E3 100%);
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 24px;
            color: white;
            text-align: center;
        }

        .last-update-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .last-update-time {
            font-size: 1.4em;
            font-weight: 700;
        }

        .last-update-date {
            font-size: 0.95em;
            opacity: 0.95;
            margin-top: 2px;
        }

        .last-update-ago {
            font-size: 0.95em;
            opacity: 0.9;
            margin-top: 4px;
        }

        .status-card {
            border-radius: 20px;
            padding: 28px 24px;
            margin-bottom: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .status-card.location-going_home {
            background: #E8F5E9;
            border: 2px solid #81C784;
        }

        .status-card.location-at_home {
            background: #E0F7FA;
            border: 2px solid #4DD0E1;
        }

        .status-card.location-outside {
            background: #FFF8E1;
            border: 2px solid #FFD54F;
        }

        .status-card.location-busy {
            background: #FFEBEE;
            border: 2px solid #E57373;
        }

        .status-card.hunger-hungry {
            background: #FCE4EC;
            border: 2px solid #F06292;
        }

        .status-card.hunger-not_hungry {
            background: #E3F2FD;
            border: 2px solid #64B5F6;
        }

        .status-label {
            font-size: 0.95em;
            color: #636E72;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .status-emoji {
            font-size: 4.5em;
            margin-bottom: 12px;
            line-height: 1;
        }

        .status-text {
            font-size: 1.4em;
            color: #2D3436;
            font-weight: 700;
            line-height: 1.4;
            word-break: keep-all;
        }

        .dad-section {
            background: linear-gradient(135deg, #FFEAA7 0%, #FDCB6E 100%);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
        }

        /* ì•„ë²„ì§€ ê¸°ë¶„ í‘œì‹œ */
        .father-info-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
        }

        .mood-display {
            font-size: 2.5em;
            min-width: 50px;
        }

        .mood-text {
            font-weight: 600;
            color: #2D3436;
        }

        .mood-time {
            font-size: 0.8em;
            color: #636E72;
        }

        /* ì•„ë²„ì§€ ê¸°ë¶„ ì„ íƒ */
        .mood-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .mood-btn {
            flex: 1;
            min-width: 50px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.2s;
        }

        .mood-btn:hover {
            transform: scale(1.05);
        }

        .mood-btn.selected {
            border-color: #2D3436;
            background: #E8F5E9;
            transform: scale(1.1);
        }

        /* ë©”ì‹œì§€ ì…ë ¥ ì„¹ì…˜ */
        .message-section {
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
        }

        .message-section-label {
            font-size: 0.9em;
            font-weight: 600;
            color: #2D3436;
            margin-bottom: 8px;
        }

        .message-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95em;
            resize: none;
            min-height: 60px;
            font-family: inherit;
        }

        .message-input:focus {
            outline: none;
            border-color: #2D3436;
            background: #fffaf0;
        }

        .dad-send-btn {
            padding: 14px 20px;
            background: #2D3436;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            width: 100%;
        }

        .dad-send-btn:hover {
            background: #1A1A1A;
        }

        .dad-send-btn:active {
            transform: scale(0.98);
        }

        /* ì•ŒëŒ ì„¤ì • */
        .notification-settings {
            background: #F0F8FF;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 2px solid #B3E5FC;
        }

        .notification-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .notification-toggle label {
            font-size: 0.95em;
            font-weight: 600;
            color: #2D3436;
            cursor: pointer;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            background: #CCC;
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.on {
            background: #4DD0E1;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.on::after {
            left: 24px;
        }

        .notification-status {
            font-size: 0.85em;
            color: #636E72;
        }

        /* ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ */
        .message-history {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #FFE8B6;
        }

        .message-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #F5E6D3;
        }

        .message-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .message-sender-info {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .message-type-badge {
            display: inline-block;
            padding: 3px 8px;
            background: #5B8A72;
            color: white;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 600;
        }

        .message-type-badge.advice {
            background: #FF6B6B;
        }

        .message-type-badge.memo {
            background: #4ECDC4;
        }

        .message-sender {
            font-size: 0.85em;
            font-weight: 600;
            color: #2D3436;
        }

        .message-sender.dad {
            color: #E17055;
        }

        .message-sender.dayoung {
            color: #6C5CE7;
        }

        .message-actions {
            display: flex;
            gap: 6px;
        }

        .msg-btn {
            padding: 3px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            transition: all 0.2s;
            background: #f0f0f0;
            color: #636E72;
        }

        .msg-btn:hover {
            background: #5B8A72;
            color: white;
        }

        .msg-btn.delete {
            background: #ffebee;
            color: #E57373;
        }

        .msg-btn.delete:hover {
            background: #E57373;
            color: white;
        }

        .msg-btn.read {
            background: #e8f5e9;
            color: #5B8A72;
        }

        .msg-btn.read:hover {
            background: #5B8A72;
            color: white;
        }

        .message-content {
            font-size: 0.95em;
            color: #2D3436;
            line-height: 1.4;
            word-break: keep-all;
            margin-bottom: 4px;
        }

        .message-time {
            font-size: 0.75em;
            color: #B2BEC3;
        }

        .refresh-btn {
            width: 100%;
            padding: 18px;
            background: #5B8A72;
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 8px;
            transition: all 0.2s ease;
        }

        .refresh-btn:hover {
            background: #4A7A62;
        }

        .refresh-btn:active {
            transform: scale(0.98);
        }

        .loading {
            text-align: center;
            color: #636E72;
            padding: 50px 20px;
        }

        .loading-spinner {
            width: 45px;
            height: 45px;
            border: 4px solid #E8E8E8;
            border-top: 4px solid #5B8A72;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 18px;
        }

        .loading-text {
            font-size: 1.1em;
        }

        /* ì•± ì„¤ì¹˜ ë°°ë„ˆ */
        .install-banner {
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            color: white;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .install-banner-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .install-banner-subtitle {
            font-size: 0.95em;
            opacity: 0.95;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .install-btn {
            width: 100%;
            padding: 16px;
            background: white;
            color: #667EEA;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .install-btn:active {
            transform: scale(0.98);
        }

        .close-banner-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.2s;
        }

        .close-banner-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: white;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #2D3436;
            color: white;
            padding: 16px 28px;
            border-radius: 12px;
            font-size: 1.05em;
            transition: transform 0.3s ease;
            z-index: 1000;
            text-align: center;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* ê´€ë¦¬ì ëª¨ë“œ í† ê¸€ */
        .mode-toggle {
            position: fixed;
            bottom: 15px;
            right: 15px;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            opacity: 0.5;
            transition: opacity 0.3s;
            z-index: 999;
        }

        .mode-toggle:hover {
            opacity: 1;
        }

        /* ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            padding: 28px;
            border-radius: 20px;
            max-width: 320px;
            width: 90%;
        }

        .modal h3 {
            margin-bottom: 18px;
            color: #2D3436;
            font-size: 1.2em;
            text-align: center;
        }

        .modal input {
            width: 100%;
            padding: 14px;
            border: 2px solid #DFE6E9;
            border-radius: 10px;
            font-size: 1.05em;
            margin-bottom: 16px;
            text-align: center;
        }

        .modal input:focus {
            outline: none;
            border-color: #5B8A72;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn.confirm {
            background: #5B8A72;
            color: white;
        }

        .modal-btn.cancel {
            background: #DFE6E9;
            color: #636E72;
        }

        /* ê´€ë¦¬ì íŒ¨ë„ */
        .admin-panel {
            display: none;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 2px dashed #DFE6E9;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-title {
            text-align: center;
            color: #5B8A72;
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #E8E8E8;
            color: #B2BEC3;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ì•± ì„¤ì¹˜ ë°°ë„ˆ -->
        <div id="installBanner" class="install-banner" style="display: none;">
            <div class="install-banner-title">ğŸ“± ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</div>
            <div class="install-banner-subtitle">
                í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ë©´ ì•±ì²˜ëŸ¼ ë¹ ë¥´ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”!<br>
                ì˜¤í”„ë¼ì¸ì—ì„œë„ ì‘ë™í•©ë‹ˆë‹¤.
            </div>
            <button id="installBtn" class="install-btn">
                <span>â¬‡ï¸</span>
                <span>ì§€ê¸ˆ ì„¤ì¹˜í•˜ê¸°</span>
            </button>
            <button id="closeBannerBtn" class="close-banner-btn">ë‚˜ì¤‘ì—</button>
        </div>

        <div class="header">
            <div class="header-emoji">ğŸ’•</div>
            <h1>ë‹¤ì˜ì´ ìƒíƒœ</h1>
            <p class="subtitle">ì•„ë²„ì§€, í¸í•˜ê²Œ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <div id="statusView" style="display: none;">
            <!-- ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê° -->
            <div class="last-update-banner">
                <div class="last-update-label">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
                <div id="lastUpdateTime" class="last-update-time">--:--</div>
                <div id="lastUpdateDate" class="last-update-date">--ë…„ --ì›” --ì¼</div>
                <div id="lastUpdateAgo" class="last-update-ago"></div>
            </div>

            <!-- ìœ„ì¹˜ ìƒíƒœ -->
            <div id="locationCard" class="status-card location-going_home">
                <div class="status-label">ğŸ“ ì§€ê¸ˆì€</div>
                <div id="locationEmoji" class="status-emoji">ğŸ </div>
                <div id="locationText" class="status-text">ì§‘ì— ê°€ê³  ìˆì–´ìš”</div>
            </div>

            <!-- ë°°ê³ í”” ìƒíƒœ -->
            <div id="hungerCard" class="status-card hunger-not_hungry">
                <div class="status-label">ğŸš ë°¥ì€</div>
                <div id="hungerEmoji" class="status-emoji">ğŸ˜Š</div>
                <div id="hungerText" class="status-text">ë°°ê°€ ì•ˆ ê³ íŒŒìš”</div>
            </div>

            <!-- ì•„ë²„ì§€ ì„¹ì…˜ -->
            <div class="dad-section">
                <!-- ì•„ë²„ì§€ ê¸°ë¶„ í‘œì‹œ -->
                <div class="father-info-header">
                    <div class="mood-display" id="fatherMoodDisplay">ğŸ˜</div>
                    <div>
                        <div class="mood-text" id="fatherMoodText">ë³´í†µ</div>
                        <div class="mood-time" id="fatherMoodTime">ì—…ë°ì´íŠ¸ ì—†ìŒ</div>
                    </div>
                </div>

                <!-- ì•„ë²„ì§€ ê¸°ë¶„ ì„ íƒ -->
                <div class="mood-selector" id="moodSelector">
                    <button class="mood-btn" data-mood="good" title="ì¢‹ìŒ">ğŸ˜Š</button>
                    <button class="mood-btn" data-mood="normal" title="ë³´í†µ">ğŸ˜</button>
                    <button class="mood-btn" data-mood="tired" title="í”¼ê³¤">ğŸ˜”</button>
                    <button class="mood-btn" data-mood="angry" title="í™”ë‚¨">ğŸ˜¡</button>
                    <button class="mood-btn" data-mood="sad" title="ìŠ¬í””">ğŸ˜¢</button>
                </div>

                <!-- 4ê°œ ë©”ì‹œì§€ ì„¹ì…˜ -->
                <div class="message-section">
                    <div class="message-section-label">ğŸ’¬ í•˜ê³ ì‹¶ì€ ë§</div>
                    <textarea id="fatherMessageInput" class="message-input" placeholder="ë‹¤ì˜ì´ì—ê²Œ í•˜ê³ ì‹¶ì€ ë§ì„ ì ì–´ì£¼ì„¸ìš”..."></textarea>
                </div>

                <div class="message-section">
                    <div class="message-section-label">â¤ï¸ ë‹¹ë¶€í•  ë§</div>
                    <textarea id="fatherAdviceInput" class="message-input" placeholder="ë‹¤ì˜ì´ì—ê²Œ ë‹¹ë¶€í•˜ê³  ì‹¶ì€ ë§ì„ ì ì–´ì£¼ì„¸ìš”..."></textarea>
                </div>

                <div class="message-section">
                    <div class="message-section-label">ğŸ“ ê¸°íƒ€ ë©”ëª¨</div>
                    <textarea id="fatherMemoInput" class="message-input" placeholder="ê¸°íƒ€ ì‚¬í•­ì„ ë©”ëª¨í•´ì£¼ì„¸ìš”..."></textarea>
                </div>

                <!-- ì €ì¥ ë²„íŠ¼ -->
                <button id="fatherSaveBtn" class="dad-send-btn" style="margin-bottom: 16px;">
                    <span>ğŸ’¾</span>
                    <span>ì•„ë²„ì§€ ì •ë³´ ì €ì¥</span>
                </button>

                <!-- ì•ŒëŒ ì„¤ì • -->
                <div class="notification-settings">
                    <div class="notification-toggle">
                        <label for="notificationToggle">ìƒˆ ë©”ì‹œì§€ ì•Œë¦¼</label>
                        <div id="notificationToggle" class="toggle-switch" role="checkbox" aria-checked="false"></div>
                    </div>
                    <div class="notification-status" id="notificationStatus">ì•Œë¦¼ì´ êº¼ì ¸ìˆìŠµë‹ˆë‹¤</div>
                </div>

                <!-- ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ -->
                <div id="messageHistory" class="message-history">
                    <div style="text-align: center; color: #B2BEC3; padding: 20px 10px; font-size: 0.95em;">
                        ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ì–´ìš”
                    </div>
                </div>
            </div>

            <!-- ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ -->
            <button id="refreshBtn" class="refresh-btn">
                <span>ğŸ”„</span>
                <span>ë‹¤ì‹œ í™•ì¸í•˜ê¸°</span>
            </button>
        </div>

        <div class="footer">
            ğŸ’• ë‹¤ì˜
        </div>
    </div>

    <!-- ê´€ë¦¬ì ëª¨ë“œ í† ê¸€ ë²„íŠ¼ -->
    <button id="modeToggle" class="mode-toggle">âš™ï¸</button>

    <!-- ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
    <div id="passwordModal" class="modal-overlay">
        <div class="modal">
            <h3>ğŸ” ë¹„ë°€ë²ˆí˜¸</h3>
            <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="modal-btn confirm" onclick="checkPassword()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const API_URL = 'https://dayoung-status.cjsghd8064.workers.dev';
        const ADMIN_PASSWORD = '242828';

        let fatherMood = 'normal';
        let notificationEnabled = localStorage.getItem('notificationEnabled') === 'true';
        let lastCheckTime = 0;
        let lastUpdateTimestamp = null;
        let pollingInterval = null;
        let isAdminMode = false;

        const moodMap = {
            'good': { emoji: 'ğŸ˜Š', text: 'ì¢‹ìŒ' },
            'normal': { emoji: 'ğŸ˜', text: 'ë³´í†µ' },
            'tired': { emoji: 'ğŸ˜”', text: 'í”¼ê³¤' },
            'angry': { emoji: 'ğŸ˜¡', text: 'í™”ë‚¨' },
            'sad': { emoji: 'ğŸ˜¢', text: 'ìŠ¬í””' }
        };

        const locationMap = {
            'going_home': { emoji: 'ğŸš¶', text: 'ì§‘ì— ê°€ê³  ìˆì–´ìš”' },
            'at_home': { emoji: 'ğŸ ', text: 'ì§‘ì— ë„ì°©í–ˆì–´ìš”!' },
            'outside': { emoji: 'ğŸŒ™', text: 'ì•„ì§ ë°–ì— ìˆì–´ìš”' },
            'busy': { emoji: 'ğŸ’¼', text: 'ì§€ê¸ˆ ë°”ë¹ ìš”' }
        };

        const hungerMap = {
            'not_hungry': { emoji: 'ğŸ˜Š', text: 'ë°° ì•ˆ ê³ íŒŒìš”' },
            'hungry': { emoji: 'ğŸ½ï¸', text: 'ë°°ê³ íŒŒìš”' }
        };

        document.addEventListener('DOMContentLoaded', () => {
            fetchStatus();
            setupEventListeners();
            registerServiceWorker();
            setupInstallPrompt();
            startPolling();
            setInterval(updateTimeAgo, 60000);
        });

        // PWA ì„¤ì¹˜ ê¸°ëŠ¥
        let deferredPrompt;
        
        function setupInstallPrompt() {
            // beforeinstallprompt ì´ë²¤íŠ¸ ìº¡ì²˜
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // ì´ë¯¸ ì„¤ì¹˜í–ˆê±°ë‚˜ ë°°ë„ˆë¥¼ ë‹«ì€ ê²½ìš° í‘œì‹œ ì•ˆ í•¨
                if (!localStorage.getItem('installBannerDismissed') && !isAppInstalled()) {
                    document.getElementById('installBanner').style.display = 'block';
                }
            });

            // ì„¤ì¹˜ ë²„íŠ¼ í´ë¦­
            document.getElementById('installBtn').addEventListener('click', async () => {
                if (!deferredPrompt) {
                    showToast('ì„¤ì¹˜ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }

                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    showToast('ì•±ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
                } else {
                    showToast('ì„¤ì¹˜ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
                }
                
                deferredPrompt = null;
                document.getElementById('installBanner').style.display = 'none';
            });

            // ë‚˜ì¤‘ì— ë²„íŠ¼ í´ë¦­
            document.getElementById('closeBannerBtn').addEventListener('click', () => {
                document.getElementById('installBanner').style.display = 'none';
                localStorage.setItem('installBannerDismissed', 'true');
            });

            // ì´ë¯¸ ì„¤ì¹˜ëœ ê²½ìš° ê°ì§€
            window.addEventListener('appinstalled', () => {
                showToast('ì•±ì´ ì„±ê³µì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
                document.getElementById('installBanner').style.display = 'none';
            });
        }

        function isAppInstalled() {
            // ë…ë¦½ ì‹¤í–‰í˜• ëª¨ë“œì¸ì§€ í™•ì¸
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }

        // Service Worker ë“±ë¡
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        console.log('Service Worker ë“±ë¡ ì„±ê³µ');
                    })
                    .catch(err => {
                        console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨:', err);
                    });
            }
        }

        function updateTimeAgo() {
            if (lastUpdateTimestamp) {
                document.getElementById('lastUpdateAgo').textContent = formatTimeAgo(lastUpdateTimestamp);
            }
        }

        function setupEventListeners() {
            // ì•„ë²„ì§€ ê¸°ë¶„ ì„ íƒ
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    fatherMood = btn.dataset.mood;
                });
            });

            // ì•„ë²„ì§€ ì •ë³´ ì €ì¥
            document.getElementById('fatherSaveBtn').addEventListener('click', saveFatherInfo);

            // ìƒˆë¡œê³ ì¹¨
            document.getElementById('refreshBtn').addEventListener('click', () => {
                document.getElementById('refreshBtn').innerHTML = '<span>â³</span><span>í™•ì¸ ì¤‘...</span>';
                fetchStatus().then(() => {
                    document.getElementById('refreshBtn').innerHTML = '<span>ğŸ”„</span><span>ë‹¤ì‹œ í™•ì¸í•˜ê¸°</span>';
                    showToast('âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ!');
                });
            });

            // ê´€ë¦¬ì ëª¨ë“œ í† ê¸€
            document.getElementById('modeToggle').addEventListener('click', () => {
                if (!isAdminMode) {
                    document.getElementById('passwordModal').classList.add('active');
                    document.getElementById('passwordInput').focus();
                } else {
                    isAdminMode = false;
                    showToast('ğŸ”’ ê´€ë¦¬ì ëª¨ë“œ ì¢…ë£Œ');
                }
            });

            // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì—”í„°í‚¤
            document.getElementById('passwordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });

            // ì•ŒëŒ í† ê¸€
            const notificationToggle = document.getElementById('notificationToggle');
            const notificationStatus = document.getElementById('notificationStatus');
            
            if (notificationEnabled) {
                notificationToggle.classList.add('on');
                notificationStatus.textContent = 'âœ… ì•Œë¦¼ì´ ì¼œì ¸ìˆìŠµë‹ˆë‹¤';
            }

            notificationToggle.addEventListener('click', () => {
                notificationEnabled = !notificationEnabled;
                localStorage.setItem('notificationEnabled', notificationEnabled);
                
                if (notificationEnabled) {
                    notificationToggle.classList.add('on');
                    notificationStatus.textContent = 'âœ… ì•Œë¦¼ì´ ì¼œì ¸ìˆìŠµë‹ˆë‹¤';
                    showToast('ğŸ”” ì•Œë¦¼ í™œì„±í™”!');
                    if ('Notification' in window && Notification.permission === 'default') {
                        Notification.requestPermission();
                    }
                } else {
                    notificationToggle.classList.remove('on');
                    notificationStatus.textContent = 'ì•Œë¦¼ì´ êº¼ì ¸ìˆìŠµë‹ˆë‹¤';
                    showToast('ğŸ”• ì•Œë¦¼ ë¹„í™œì„±í™”');
                }
            });
        }

        async function saveFatherInfo() {
            const message = document.getElementById('fatherMessageInput').value.trim();
            const advice = document.getElementById('fatherAdviceInput').value.trim();
            const memo = document.getElementById('fatherMemoInput').value.trim();

            if (!fatherMood && !message && !advice && !memo) {
                showToast('ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            try {
                const body = {};
                if (fatherMood) body.fatherMood = fatherMood;
                if (message) body.fatherMessage = message;
                if (advice) body.fatherAdvice = advice;
                if (memo) body.fatherMemo = memo;

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                updateDisplay(data);
                
                document.getElementById('fatherMessageInput').value = '';
                document.getElementById('fatherAdviceInput').value = '';
                document.getElementById('fatherMemoInput').value = '';
                
                showToast('âœ… ì •ë³´ ì €ì¥ ì™„ë£Œ!');
            } catch (error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                showToast('âŒ ì €ì¥ ì‹¤íŒ¨');
            }
        }

        function startPolling() {
            pollingInterval = setInterval(() => {
                console.log('ğŸ“¡ ìƒˆ ë©”ì‹œì§€ í™•ì¸...');
                fetchStatus();
            }, 3 * 60 * 1000); // 3ë¶„
        }

        async function fetchStatus() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('statusView').style.display = 'block';
                
                updateDisplay(data);
                return data;
            } catch (error) {
                console.error('ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('loading').innerHTML = 
                    '<div style="font-size:3em; margin-bottom:15px;">ğŸ˜¢</div>' +
                    '<div class="loading-text">ì—°ê²°í•  ìˆ˜ ì—†ì–´ìš”</div>';
            }
        }

        function updateDisplay(data) {
            // ì‹œê°„ ì—…ë°ì´íŠ¸
            const locationTime = data.locationUpdated ? new Date(data.locationUpdated) : null;
            const hungerTime = data.hungerUpdated ? new Date(data.hungerUpdated) : null;
            
            let latestTime = locationTime;
            if (hungerTime && (!latestTime || hungerTime > latestTime)) {
                latestTime = hungerTime;
            }
            
            if (latestTime) {
                lastUpdateTimestamp = latestTime;
                document.getElementById('lastUpdateTime').textContent = formatTime(latestTime);
                document.getElementById('lastUpdateDate').textContent = formatDate(latestTime);
                document.getElementById('lastUpdateAgo').textContent = formatTimeAgo(latestTime);
            }

            // ìœ„ì¹˜
            const location = locationMap[data.location] || locationMap['going_home'];
            document.getElementById('locationEmoji').textContent = location.emoji;
            document.getElementById('locationText').textContent = location.text;
            document.getElementById('locationCard').className = 'status-card location-' + (data.location || 'going_home');

            // ë°°ê³ í””
            const hunger = hungerMap[data.hunger] || hungerMap['not_hungry'];
            document.getElementById('hungerEmoji').textContent = hunger.emoji;
            document.getElementById('hungerText').textContent = hunger.text;
            document.getElementById('hungerCard').className = 'status-card hunger-' + (data.hunger || 'not_hungry');

            // ì•„ë²„ì§€ ê¸°ë¶„
            updateFatherInfo(data);

            // ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬
            displayMessageHistory(data.messages);

            // ìƒˆ ë©”ì‹œì§€ ì•ŒëŒ (Polling)
            if (data.messages && data.messages.length > 0) {
                const latestMsg = data.messages[data.messages.length - 1];
                
                if (latestMsg.sender === 'dad' && lastCheckTime < new Date(latestMsg.timestamp).getTime()) {
                    sendNotification('ğŸ’¬ ì•„ë²„ì§€ê°€ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í–ˆì–´ìš”!', {
                        body: latestMsg.content.substring(0, 50)
                    });
                    lastCheckTime = new Date(latestMsg.timestamp).getTime();
                }
            }
        }

        function updateFatherInfo(data) {
            if (data.fatherMood) {
                const mood = moodMap[data.fatherMood];
                document.getElementById('fatherMoodDisplay').textContent = mood.emoji;
                document.getElementById('fatherMoodText').textContent = mood.text;
                
                if (data.fatherMoodUpdated) {
                    document.getElementById('fatherMoodTime').textContent = 
                        formatTime(new Date(data.fatherMoodUpdated));
                }
            }
        }

        function displayMessageHistory(messages) {
            const history = document.getElementById('messageHistory');
            
            if (!messages || messages.length === 0) {
                history.innerHTML = '<div style="text-align: center; color: #B2BEC3; padding: 20px 10px; font-size: 0.95em;">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ì–´ìš”</div>';
                return;
            }

            const typeText = {
                'message': 'ğŸ’¬',
                'advice': 'â¤ï¸',
                'memo': 'ğŸ“'
            };

            history.innerHTML = messages.map(msg => `
                <div class="message-item">
                    <div class="message-header">
                        <div class="message-sender-info">
                            <span class="message-type-badge${msg.type === 'advice' ? ' advice' : msg.type === 'memo' ? ' memo' : ''}">
                                ${typeText[msg.type] || 'ğŸ’¬'}
                            </span>
                            <span class="message-sender${msg.sender === 'dad' ? ' dad' : ' dayoung'}">
                                ${msg.sender === 'dad' ? 'ğŸ‘¨ ì•„ë²„ì§€' : 'ğŸ‘§ ë‹¤ì˜'}
                            </span>
                        </div>
                        <div class="message-actions">
                            ${!msg.read ? `<button class="msg-btn read" onclick="markAsRead('${msg.id}')">âœ“</button>` : ''}
                            <button class="msg-btn delete" onclick="deleteMessage('${msg.id}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="message-content">${escapeHtml(msg.content)}</div>
                    <div class="message-time">${formatTime(new Date(msg.timestamp))} Â· ${formatTimeAgo(new Date(msg.timestamp))}</div>
                </div>
            `).join('');
            
            history.scrollTop = history.scrollHeight;
        }

        async function deleteMessage(messageId) {
            try {
                const response = await fetch(API_URL, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messageId })
                });

                const data = await response.json();
                updateDisplay(data);
                showToast('ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ');
            } catch (error) {
                console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                showToast('âŒ ì‚­ì œ ì‹¤íŒ¨');
            }
        }

        async function markAsRead(messageId) {
            showToast('âœ… ì½ìŒ í‘œì‹œ ì™„ë£Œ');
        }

        function sendNotification(title, options = {}) {
            if (!notificationEnabled) return;
            
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    icon: 'icon-192.png',
                    tag: 'dayoung-status',
                    ...options
                });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('ko-KR', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        function formatDate(date) {
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'ë°©ê¸ˆ ì „';
            if (minutes < 60) return minutes + 'ë¶„ ì „';
            if (hours < 24) return hours + 'ì‹œê°„ ì „';
            if (days === 1) return 'ì–´ì œ';
            return days + 'ì¼ ì „';
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }

        function checkPassword() {
            const input = document.getElementById('passwordInput');
            if (input.value === ADMIN_PASSWORD) {
                isAdminMode = true;
                closeModal();
                showToast('ğŸ”“ ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”');
            } else {
                showToast('âŒ ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜');
                input.value = '';
            }
        }

        function closeModal() {
            document.getElementById('passwordModal').classList.remove('active');
            document.getElementById('passwordInput').value = '';
        }
    </script>
</body>
</html>
