<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¤ì˜ì´ ìƒíƒœ ì•Œë¦¼</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#6366F1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ë‹¤ì˜ì´ ìƒíƒœ">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <style>
        :root{--primary:#6366F1;--primary-light:#818CF8;--primary-dark:#4F46E5;--secondary:#EC4899;--success:#10B981;--warning:#F59E0B;--danger:#EF4444;--bg:#F8FAFC;--card:#FFFFFF;--text:#1E293B;--text-muted:#64748B;--border:#E2E8F0;--shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -2px rgba(0,0,0,0.1);--shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -4px rgba(0,0,0,0.1)}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:-apple-system,BlinkMacSystemFont,'Malgun Gothic','ë§‘ì€ ê³ ë”•',sans-serif;background:var(--bg);min-height:100vh;min-height:100dvh;color:var(--text);line-height:1.6;overflow-x:hidden}
        .app{max-width:480px;margin:0 auto;padding:16px;padding-bottom:100px}
        .header{text-align:center;padding:24px 0;margin-bottom:16px}
        .header-icon{width:72px;height:72px;background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);border-radius:24px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:36px;box-shadow:var(--shadow-lg)}
        .header h1{font-size:1.5rem;font-weight:700;margin-bottom:4px}
        .header p{font-size:0.9rem;color:var(--text-muted)}
        .install-banner{display:none;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);border-radius:20px;padding:20px;margin-bottom:16px;color:white;animation:slideIn 0.3s ease}
        @keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .install-banner-content{display:flex;align-items:center;gap:16px;margin-bottom:16px}
        .install-icon{width:48px;height:48px;background:rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0}
        .install-text h3{font-size:1rem;font-weight:600;margin-bottom:2px}
        .install-text p{font-size:0.85rem;opacity:0.9}
        .install-actions{display:flex;gap:10px}
        .install-btn{flex:1;padding:12px;background:white;color:var(--primary);border:none;border-radius:12px;font-size:0.95rem;font-weight:600;cursor:pointer}
        .install-btn:active{transform:scale(0.98)}
        .install-later{padding:12px 16px;background:rgba(255,255,255,0.15);color:white;border:none;border-radius:12px;font-size:0.9rem;cursor:pointer}
        .update-banner{background:var(--card);border-radius:16px;padding:16px 20px;margin-bottom:16px;display:flex;align-items:center;gap:14px;box-shadow:var(--shadow)}
        .update-indicator{width:10px;height:10px;background:var(--success);border-radius:50%;animation:pulse 2s infinite;flex-shrink:0}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .update-info{flex:1}
        .update-label{font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
        .update-time{font-size:1rem;font-weight:600}
        .update-date{font-size:0.85rem;color:var(--text-muted);margin-top:2px}
        .update-ago{font-size:0.8rem;color:var(--primary);font-weight:500}
        .status-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
        .status-card{background:var(--card);border-radius:20px;padding:20px 16px;text-align:center;box-shadow:var(--shadow);border:2px solid transparent}
        .status-card.location-going_home{border-color:#A5F3FC;background:linear-gradient(180deg,#ECFEFF 0%,white 100%)}
        .status-card.location-at_home{border-color:#BBF7D0;background:linear-gradient(180deg,#F0FDF4 0%,white 100%)}
        .status-card.location-outside{border-color:#FDE68A;background:linear-gradient(180deg,#FFFBEB 0%,white 100%)}
        .status-card.location-busy{border-color:#FECACA;background:linear-gradient(180deg,#FEF2F2 0%,white 100%)}
        .status-card.hunger-hungry{border-color:#FBCFE8;background:linear-gradient(180deg,#FDF2F8 0%,white 100%)}
        .status-card.hunger-not_hungry{border-color:#C7D2FE;background:linear-gradient(180deg,#EEF2FF 0%,white 100%)}
        .status-label{font-size:0.8rem;color:var(--text-muted);margin-bottom:8px;font-weight:500}
        .status-emoji{font-size:2.8rem;margin-bottom:8px;line-height:1}
        .status-text{font-size:0.95rem;font-weight:600;word-break:keep-all}
        .section{background:var(--card);border-radius:20px;padding:20px;margin-bottom:16px;box-shadow:var(--shadow)}
        .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
        .section-header-left{display:flex;align-items:center;gap:10px}
        .section-icon{width:36px;height:36px;background:linear-gradient(135deg,#FBBF24 0%,#F59E0B 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
        .section-title{font-size:1rem;font-weight:600}
        .admin-badge{padding:4px 10px;background:var(--danger);color:white;border-radius:20px;font-size:0.7rem;font-weight:600;display:none}
        .admin-badge.active{display:inline-block}
        .mood-display{display:flex;align-items:center;gap:12px;padding:14px 16px;background:#FFFBEB;border-radius:14px;margin-bottom:16px}
        .mood-emoji{font-size:2rem}
        .mood-info{flex:1}
        .mood-text{font-weight:600}
        .mood-time{font-size:0.8rem;color:var(--text-muted)}
        .mood-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px}
        .mood-btn{aspect-ratio:1;border:2px solid var(--border);border-radius:14px;background:white;cursor:pointer;font-size:1.5rem;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
        .mood-btn:active{transform:scale(0.95)}
        .mood-btn.selected{border-color:var(--primary);background:#EEF2FF;transform:scale(1.05)}
        .input-group{margin-bottom:14px}
        .input-label{display:flex;align-items:center;gap:6px;font-size:0.85rem;font-weight:500;margin-bottom:8px}
        .input-field{width:100%;padding:14px 16px;border:2px solid var(--border);border-radius:14px;font-size:0.95rem;font-family:inherit;resize:none;min-height:70px}
        .input-field:focus{outline:none;border-color:var(--primary);background:#FAFAFF}
        .btn{width:100%;padding:16px;border:none;border-radius:14px;font-size:1rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn:active{transform:scale(0.98)}
        .btn-secondary{background:var(--text);color:white}
        .btn-admin{background:var(--danger);color:white;margin-top:10px}
        .notification-row{display:flex;align-items:center;justify-content:space-between;padding:16px;background:#F1F5F9;border-radius:14px;margin-bottom:14px}
        .notification-info{display:flex;align-items:center;gap:10px}
        .notification-label{font-size:0.9rem;font-weight:500}
        .toggle{width:52px;height:28px;background:#CBD5E1;border-radius:14px;position:relative;cursor:pointer;transition:background 0.3s}
        .toggle.on{background:var(--success)}
        .toggle::after{content:'';position:absolute;width:22px;height:22px;background:white;border-radius:50%;top:3px;left:3px;transition:left 0.3s;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
        .toggle.on::after{left:27px}
        /* ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ - ë‚ ì§œë³„ ê·¸ë£¹í™” */
        .message-section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
        .message-section-title{font-size:0.9rem;font-weight:600;color:var(--text)}
        .message-list{max-height:400px;overflow-y:auto;-webkit-overflow-scrolling:touch}
        .message-empty{text-align:center;padding:32px 16px;color:var(--text-muted);font-size:0.9rem}
        .date-group{margin-bottom:16px}
        .date-header{display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:8px 12px;background:linear-gradient(90deg,#EEF2FF 0%,transparent 100%);border-radius:8px}
        .date-header-icon{font-size:0.9rem}
        .date-header-text{font-size:0.85rem;font-weight:600;color:var(--primary)}
        .date-header-count{font-size:0.75rem;color:var(--text-muted);margin-left:auto}
        .message-item{padding:14px;background:#F8FAFC;border-radius:14px;margin-bottom:8px;border-left:3px solid var(--primary)}
        .message-item:last-child{margin-bottom:0}
        .message-item.advice{border-left-color:var(--secondary)}
        .message-item.memo{border-left-color:var(--success)}
        .message-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
        .message-meta{display:flex;align-items:center;gap:8px}
        .message-badge{padding:3px 8px;border-radius:6px;font-size:0.7rem;font-weight:600}
        .message-badge.message{background:#DBEAFE;color:#1D4ED8}
        .message-badge.advice{background:#FCE7F3;color:#BE185D}
        .message-badge.memo{background:#D1FAE5;color:#047857}
        .message-sender{font-size:0.8rem;font-weight:500;color:var(--text-muted)}
        .message-actions{display:flex;gap:4px}
        .msg-action-btn{width:28px;height:28px;border:none;border-radius:8px;background:white;cursor:pointer;font-size:0.75rem;display:flex;align-items:center;justify-content:center}
        .msg-action-btn.delete{color:var(--danger)}
        .message-content{font-size:0.9rem;line-height:1.5;word-break:keep-all}
        .message-time{font-size:0.75rem;color:var(--text-muted);margin-top:6px}
        .fab{position:fixed;bottom:24px;right:24px;width:60px;height:60px;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);border:none;border-radius:50%;color:white;font-size:24px;cursor:pointer;box-shadow:0 4px 15px rgba(99,102,241,0.4);display:flex;align-items:center;justify-content:center;z-index:100}
        .fab:active{transform:scale(0.95)}
        .fab.spinning span{animation:spin 1s linear infinite}
        @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
        .settings-btn{position:fixed;bottom:24px;left:24px;width:48px;height:48px;background:white;border:none;border-radius:50%;color:var(--text-muted);font-size:20px;cursor:pointer;box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;opacity:0.7;z-index:100}
        .settings-btn:hover{opacity:1}
        .settings-btn.admin-active{background:var(--danger);color:white;opacity:1}
        .loading{text-align:center;padding:60px 20px}
        .loading-spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
        .loading-text{color:var(--text-muted);font-size:0.95rem}
        .toast{position:fixed;top:24px;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--text);color:white;padding:14px 24px;border-radius:12px;font-size:0.95rem;z-index:1000;transition:transform 0.3s ease;max-width:calc(100% - 32px);text-align:center}
        .toast.show{transform:translateX(-50%) translateY(0)}
        .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000;padding:16px}
        .modal-overlay.active{display:flex}
        .modal{background:white;padding:28px 24px;border-radius:24px;max-width:340px;width:100%}
        .modal h3{text-align:center;font-size:1.2rem;margin-bottom:20px}
        .modal input{width:100%;padding:16px;border:2px solid var(--border);border-radius:14px;font-size:1rem;text-align:center;margin-bottom:16px}
        .modal input:focus{outline:none;border-color:var(--primary)}
        .modal-btns{display:flex;gap:10px}
        .modal-btn{flex:1;padding:14px;border:none;border-radius:12px;font-size:1rem;font-weight:600;cursor:pointer}
        .modal-btn.confirm{background:var(--primary);color:white}
        .modal-btn.cancel{background:#F1F5F9;color:var(--text-muted)}
        .ios-steps{text-align:left;line-height:1.8;font-size:0.9rem}
        .ios-steps strong{color:white}
        @media(max-width:360px){.status-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="app">
        <div id="installBanner" class="install-banner">
            <div class="install-banner-content">
                <div class="install-icon">ğŸ“²</div>
                <div class="install-text"><h3>ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</h3><p>í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ë©´ ë” ë¹ ë¥´ê²Œ!</p></div>
            </div>
            <div class="install-actions">
                <button id="installBtn" class="install-btn">ì„¤ì¹˜í•˜ê¸°</button>
                <button id="closeBannerBtn" class="install-later">ë‚˜ì¤‘ì—</button>
            </div>
        </div>
        <div id="iosInstallBanner" class="install-banner">
            <div class="install-banner-content">
                <div class="install-icon">ğŸ“±</div>
                <div class="install-text"><h3>í™ˆ í™”ë©´ì— ì¶”ê°€</h3><p>ì•„ë˜ ë°©ë²•ìœ¼ë¡œ ì„¤ì¹˜í•˜ì„¸ìš”</p></div>
            </div>
            <div class="ios-steps">1. í•˜ë‹¨ì˜ <strong>ê³µìœ  ğŸ“¤</strong> ë²„íŠ¼ ëˆ„ë¥´ê¸°<br>2. <strong>"í™ˆ í™”ë©´ì— ì¶”ê°€"</strong> ì„ íƒ<br>3. ì˜¤ë¥¸ìª½ ìƒë‹¨ <strong>"ì¶”ê°€"</strong> ëˆ„ë¥´ê¸°</div>
            <button id="closeIosBannerBtn" class="install-later" style="width:100%;margin-top:16px;">í™•ì¸í–ˆì–´ìš”</button>
        </div>
        <header class="header">
            <div class="header-icon">ğŸ’•</div>
            <h1>ë‹¤ì˜ì´ ìƒíƒœ</h1>
            <p>ì•„ë²„ì§€, í¸í•˜ê²Œ í™•ì¸í•˜ì„¸ìš”</p>
        </header>
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
        <div id="statusView" style="display:none;">
            <div class="update-banner">
                <div class="update-indicator"></div>
                <div class="update-info">
                    <div class="update-label">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
                    <div class="update-time" id="lastUpdateTime">--:--</div>
                    <div class="update-date" id="lastUpdateDate">----ë…„ --ì›” --ì¼</div>
                </div>
                <div class="update-ago" id="lastUpdateAgo"></div>
            </div>
            <div class="status-grid">
                <div id="locationCard" class="status-card location-going_home">
                    <div class="status-label">ğŸ“ ì§€ê¸ˆì€</div>
                    <div id="locationEmoji" class="status-emoji">ğŸ </div>
                    <div id="locationText" class="status-text">ì§‘ì— ê°€ê³  ìˆì–´ìš”</div>
                </div>
                <div id="hungerCard" class="status-card hunger-not_hungry">
                    <div class="status-label">ğŸš ë°¥ì€</div>
                    <div id="hungerEmoji" class="status-emoji">ğŸ˜Š</div>
                    <div id="hungerText" class="status-text">ë°°ê°€ ì•ˆ ê³ íŒŒìš”</div>
                </div>
            </div>
            <div class="section">
                <div class="section-header">
                    <div class="section-header-left">
                        <div class="section-icon">ğŸ‘¨</div>
                        <div class="section-title">ì•„ë²„ì§€</div>
                    </div>
                    <span id="adminBadge" class="admin-badge">ê´€ë¦¬ì</span>
                </div>
                <div class="mood-display">
                    <div class="mood-emoji" id="fatherMoodDisplay">ğŸ˜</div>
                    <div class="mood-info">
                        <div class="mood-text" id="fatherMoodText">ë³´í†µ</div>
                        <div class="mood-time" id="fatherMoodTime">ì—…ë°ì´íŠ¸ ì—†ìŒ</div>
                    </div>
                </div>
                <div class="mood-grid" id="moodSelector">
                    <button class="mood-btn" data-mood="good">ğŸ˜Š</button>
                    <button class="mood-btn" data-mood="normal">ğŸ˜</button>
                    <button class="mood-btn" data-mood="tired">ğŸ˜”</button>
                    <button class="mood-btn" data-mood="angry">ğŸ˜¡</button>
                    <button class="mood-btn" data-mood="sad">ğŸ˜¢</button>
                </div>
                <div class="input-group">
                    <label class="input-label">ğŸ’¬ í•˜ê³ ì‹¶ì€ ë§</label>
                    <textarea id="fatherMessageInput" class="input-field" placeholder="ë‹¤ì˜ì´ì—ê²Œ í•˜ê³ ì‹¶ì€ ë§..."></textarea>
                </div>
                <div class="input-group">
                    <label class="input-label">â¤ï¸ ë‹¹ë¶€í•  ë§</label>
                    <textarea id="fatherAdviceInput" class="input-field" placeholder="ë‹¤ì˜ì´ì—ê²Œ ë‹¹ë¶€í•˜ê³  ì‹¶ì€ ë§..."></textarea>
                </div>
                <div class="input-group">
                    <label class="input-label">ğŸ“ ê¸°íƒ€ ë©”ëª¨</label>
                    <textarea id="fatherMemoInput" class="input-field" placeholder="ê¸°íƒ€ ì‚¬í•­ ë©”ëª¨..."></textarea>
                </div>
                <button id="fatherSaveBtn" class="btn btn-secondary"><span>ğŸ’¾</span><span>ì €ì¥í•˜ê¸°</span></button>
                <button id="adminLoginBtn" class="btn btn-admin"><span>ğŸ”</span><span>ê´€ë¦¬ì ë¡œê·¸ì¸</span></button>
                <div style="margin-top:16px">
                    <div class="notification-row">
                        <div class="notification-info"><span>ğŸ””</span><span class="notification-label">ìƒˆ ë©”ì‹œì§€ ì•Œë¦¼</span></div>
                        <div id="notificationToggle" class="toggle"></div>
                    </div>
                </div>
                <div class="message-section-header">
                    <div class="message-section-title">ğŸ“‹ ë©”ì‹œì§€ ê¸°ë¡</div>
                </div>
                <div id="messageHistory" class="message-list"><div class="message-empty">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ì–´ìš”</div></div>
            </div>
        </div>
    </div>
    <button id="refreshBtn" class="fab"><span>ğŸ”„</span></button>
    <button id="modeToggle" class="settings-btn">âš™ï¸</button>
    <div id="passwordModal" class="modal-overlay">
        <div class="modal">
            <h3>ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</h3>
            <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="modal-btn confirm" onclick="checkPassword()">í™•ì¸</button>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    <script>
        const API_URL = 'https://dayoung-status.cjsghd8064.workers.dev';
        const ADMIN_PASSWORD = '242828';
        let fatherMood = 'normal', notificationEnabled = localStorage.getItem('notificationEnabled') === 'true';
        let lastCheckTime = 0, lastUpdateTimestamp = null, pollingInterval = null, isAdminMode = false, deferredPrompt;

        const moodMap = {good:{emoji:'ğŸ˜Š',text:'ì¢‹ìŒ'},normal:{emoji:'ğŸ˜',text:'ë³´í†µ'},tired:{emoji:'ğŸ˜”',text:'í”¼ê³¤'},angry:{emoji:'ğŸ˜¡',text:'í™”ë‚¨'},sad:{emoji:'ğŸ˜¢',text:'ìŠ¬í””'}};
        const locationMap = {going_home:{emoji:'ğŸš¶',text:'ì§‘ì— ê°€ê³  ìˆì–´ìš”'},at_home:{emoji:'ğŸ ',text:'ì§‘ì— ë„ì°©í–ˆì–´ìš”!'},outside:{emoji:'ğŸŒ™',text:'ì•„ì§ ë°–ì— ìˆì–´ìš”'},busy:{emoji:'ğŸ’¼',text:'ì§€ê¸ˆ ë°”ë¹ ìš”'}};
        const hungerMap = {not_hungry:{emoji:'ğŸ˜Š',text:'ë°° ì•ˆ ê³ íŒŒìš”'},hungry:{emoji:'ğŸ½ï¸',text:'ë°°ê³ íŒŒìš”'}};

        document.addEventListener('DOMContentLoaded', () => {
            fetchStatus();
            setupEventListeners();
            registerServiceWorker();
            setupInstallPrompt();
            startPolling();
            setInterval(updateTimeAgo, 60000);
        });

        function setupInstallPrompt() {
            const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isInStandaloneMode = ('standalone' in window.navigator) && window.navigator.standalone;
            const isInstalled = isAppInstalled();
            const bannerDismissed = localStorage.getItem('installBannerDismissed');
            if (isInstalled || isInStandaloneMode || bannerDismissed) return;
            if (isIOS) {
                document.getElementById('iosInstallBanner').style.display = 'block';
                document.getElementById('closeIosBannerBtn').addEventListener('click', () => {
                    document.getElementById('iosInstallBanner').style.display = 'none';
                    localStorage.setItem('installBannerDismissed', 'true');
                });
            }
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault(); deferredPrompt = e;
                if (!bannerDismissed && !isInstalled) document.getElementById('installBanner').style.display = 'block';
            });
            document.getElementById('installBtn').addEventListener('click', async () => {
                if (!deferredPrompt) { showToast('Chrome ë¸Œë¼ìš°ì €ì—ì„œ ì‚¬ìš©í•˜ì„¸ìš”'); return; }
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') { showToast('ì•± ì„¤ì¹˜ ì™„ë£Œ! ğŸ‰'); localStorage.setItem('installBannerDismissed', 'true'); }
                deferredPrompt = null; document.getElementById('installBanner').style.display = 'none';
            });
            document.getElementById('closeBannerBtn').addEventListener('click', () => {
                document.getElementById('installBanner').style.display = 'none';
                localStorage.setItem('installBannerDismissed', 'true');
            });
            window.addEventListener('appinstalled', () => {
                showToast('ì•±ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
                document.getElementById('installBanner').style.display = 'none';
                localStorage.setItem('installBannerDismissed', 'true');
            });
        }

        function isAppInstalled() { return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true; }
        function registerServiceWorker() { if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW ë“±ë¡ ì‹¤íŒ¨:', err)); }
        function updateTimeAgo() { if (lastUpdateTimestamp) document.getElementById('lastUpdateAgo').textContent = formatTimeAgo(lastUpdateTimestamp); }

        function updateAdminUI() {
            const badge = document.getElementById('adminBadge');
            const settingsBtn = document.getElementById('modeToggle');
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            if (isAdminMode) {
                badge.classList.add('active');
                settingsBtn.classList.add('admin-active');
                adminLoginBtn.innerHTML = '<span>ğŸ”“</span><span>ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ</span>';
            } else {
                badge.classList.remove('active');
                settingsBtn.classList.remove('admin-active');
                adminLoginBtn.innerHTML = '<span>ğŸ”</span><span>ê´€ë¦¬ì ë¡œê·¸ì¸</span>';
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    fatherMood = btn.dataset.mood;
                });
            });
            document.getElementById('fatherSaveBtn').addEventListener('click', saveFatherInfo);
            document.getElementById('refreshBtn').addEventListener('click', () => {
                const btn = document.getElementById('refreshBtn');
                btn.classList.add('spinning');
                fetchStatus().then(() => { btn.classList.remove('spinning'); showToast('âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ!'); });
            });
            // ê´€ë¦¬ì ë²„íŠ¼ (ëª…ì‹œì )
            document.getElementById('adminLoginBtn').addEventListener('click', () => {
                if (!isAdminMode) {
                    document.getElementById('passwordModal').classList.add('active');
                    document.getElementById('passwordInput').focus();
                } else {
                    isAdminMode = false;
                    updateAdminUI();
                    showToast('ğŸ”’ ê´€ë¦¬ì ëª¨ë“œ ì¢…ë£Œ');
                }
            });
            // ì„¤ì • ë²„íŠ¼ (í†±ë‹ˆë°”í€´)
            document.getElementById('modeToggle').addEventListener('click', () => {
                if (!isAdminMode) {
                    document.getElementById('passwordModal').classList.add('active');
                    document.getElementById('passwordInput').focus();
                } else {
                    isAdminMode = false;
                    updateAdminUI();
                    showToast('ğŸ”’ ê´€ë¦¬ì ëª¨ë“œ ì¢…ë£Œ');
                }
            });
            document.getElementById('passwordInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') checkPassword(); });
            const notificationToggle = document.getElementById('notificationToggle');
            if (notificationEnabled) notificationToggle.classList.add('on');
            notificationToggle.addEventListener('click', () => {
                notificationEnabled = !notificationEnabled;
                localStorage.setItem('notificationEnabled', notificationEnabled);
                if (notificationEnabled) { notificationToggle.classList.add('on'); showToast('ğŸ”” ì•Œë¦¼ ì¼œì§'); if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission(); }
                else { notificationToggle.classList.remove('on'); showToast('ğŸ”• ì•Œë¦¼ êº¼ì§'); }
            });
        }

        async function saveFatherInfo() {
            const message = document.getElementById('fatherMessageInput').value.trim();
            const advice = document.getElementById('fatherAdviceInput').value.trim();
            const memo = document.getElementById('fatherMemoInput').value.trim();
            if (!fatherMood && !message && !advice && !memo) { showToast('ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
            try {
                const body = {};
                if (fatherMood) body.fatherMood = fatherMood;
                if (message) body.fatherMessage = message;
                if (advice) body.fatherAdvice = advice;
                if (memo) body.fatherMemo = memo;
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const data = await response.json();
                updateDisplay(data);
                document.getElementById('fatherMessageInput').value = '';
                document.getElementById('fatherAdviceInput').value = '';
                document.getElementById('fatherMemoInput').value = '';
                showToast('âœ… ì €ì¥ ì™„ë£Œ!');
            } catch (error) { console.error('ì €ì¥ ì‹¤íŒ¨:', error); showToast('âŒ ì €ì¥ ì‹¤íŒ¨'); }
        }

        function startPolling() { pollingInterval = setInterval(() => fetchStatus(), 3 * 60 * 1000); }

        async function fetchStatus() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('statusView').style.display = 'block';
                updateDisplay(data);
                return data;
            } catch (error) {
                console.error('ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('loading').innerHTML = '<div style="font-size:3em;margin-bottom:15px;">ğŸ˜¢</div><div class="loading-text">ì—°ê²°í•  ìˆ˜ ì—†ì–´ìš”</div>';
            }
        }

        function updateDisplay(data) {
            const locationTime = data.locationUpdated ? new Date(data.locationUpdated) : null;
            const hungerTime = data.hungerUpdated ? new Date(data.hungerUpdated) : null;
            let latestTime = locationTime;
            if (hungerTime && (!latestTime || hungerTime > latestTime)) latestTime = hungerTime;
            if (latestTime) {
                lastUpdateTimestamp = latestTime;
                document.getElementById('lastUpdateTime').textContent = formatTime(latestTime);
                document.getElementById('lastUpdateDate').textContent = formatFullDate(latestTime);
                document.getElementById('lastUpdateAgo').textContent = formatTimeAgo(latestTime);
            }
            const location = locationMap[data.location] || locationMap['going_home'];
            document.getElementById('locationEmoji').textContent = location.emoji;
            document.getElementById('locationText').textContent = location.text;
            document.getElementById('locationCard').className = 'status-card location-' + (data.location || 'going_home');
            const hunger = hungerMap[data.hunger] || hungerMap['not_hungry'];
            document.getElementById('hungerEmoji').textContent = hunger.emoji;
            document.getElementById('hungerText').textContent = hunger.text;
            document.getElementById('hungerCard').className = 'status-card hunger-' + (data.hunger || 'not_hungry');
            updateFatherInfo(data);
            displayMessageHistory(data.messages);
            if (data.messages && data.messages.length > 0) {
                const latestMsg = data.messages[data.messages.length - 1];
                if (latestMsg.sender === 'dad' && lastCheckTime < new Date(latestMsg.timestamp).getTime()) {
                    sendNotification('ğŸ’¬ ì•„ë²„ì§€ê°€ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í–ˆì–´ìš”!', { body: latestMsg.content.substring(0, 50) });
                    lastCheckTime = new Date(latestMsg.timestamp).getTime();
                }
            }
        }

        function updateFatherInfo(data) {
            if (data.fatherMood) {
                const mood = moodMap[data.fatherMood];
                document.getElementById('fatherMoodDisplay').textContent = mood.emoji;
                document.getElementById('fatherMoodText').textContent = mood.text;
                if (data.fatherMoodUpdated) document.getElementById('fatherMoodTime').textContent = formatTime(new Date(data.fatherMoodUpdated));
            }
        }

        function displayMessageHistory(messages) {
            const history = document.getElementById('messageHistory');
            if (!messages || messages.length === 0) { history.innerHTML = '<div class="message-empty">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ì–´ìš”</div>'; return; }
            
            // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
            const grouped = {};
            messages.forEach(msg => {
                const date = new Date(msg.timestamp);
                const dateKey = formatDateKey(date);
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(msg);
            });
            
            // ë‚ ì§œ í‚¤ë¥¼ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
            
            const typeText = {message:'ğŸ’¬ ë©”ì‹œì§€',advice:'â¤ï¸ ë‹¹ë¶€',memo:'ğŸ“ ë©”ëª¨'};
            const typeClass = {message:'message',advice:'advice',memo:'memo'};
            
            let html = '';
            sortedDates.forEach(dateKey => {
                const msgs = grouped[dateKey];
                const dateObj = new Date(dateKey);
                const displayDate = formatGroupDate(dateObj);
                
                html += `<div class="date-group">
                    <div class="date-header">
                        <span class="date-header-icon">ğŸ“…</span>
                        <span class="date-header-text">${displayDate}</span>
                        <span class="date-header-count">${msgs.length}ê°œ</span>
                    </div>`;
                
                // í•´ë‹¹ ë‚ ì§œì˜ ë©”ì‹œì§€ë“¤ (ì‹œê°„ìˆœ ì •ë ¬)
                msgs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                msgs.forEach(msg => {
                    html += `<div class="message-item ${typeClass[msg.type] || 'message'}">
                        <div class="message-header">
                            <div class="message-meta">
                                <span class="message-badge ${typeClass[msg.type] || 'message'}">${typeText[msg.type] || 'ğŸ’¬ ë©”ì‹œì§€'}</span>
                                <span class="message-sender">${msg.sender === 'dad' ? 'ğŸ‘¨ ì•„ë²„ì§€' : 'ğŸ‘§ ë‹¤ì˜'}</span>
                            </div>
                            <div class="message-actions"><button class="msg-action-btn delete" onclick="deleteMessage('${msg.id}')">ğŸ—‘ï¸</button></div>
                        </div>
                        <div class="message-content">${escapeHtml(msg.content)}</div>
                        <div class="message-time">${formatTime(new Date(msg.timestamp))}</div>
                    </div>`;
                });
                html += '</div>';
            });
            
            history.innerHTML = html;
        }

        async function deleteMessage(messageId) {
            try {
                const response = await fetch(API_URL, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ messageId }) });
                const data = await response.json();
                updateDisplay(data);
                showToast('ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ');
            } catch (error) { console.error('ì‚­ì œ ì‹¤íŒ¨:', error); showToast('âŒ ì‚­ì œ ì‹¤íŒ¨'); }
        }

        function sendNotification(title, options = {}) {
            if (!notificationEnabled) return;
            if ('Notification' in window && Notification.permission === 'granted') new Notification(title, { icon: 'icon-192.png', tag: 'dayoung-status', ...options });
        }

        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function formatTime(date) { return date.toLocaleTimeString('ko-KR', { hour: 'numeric', minute: '2-digit', hour12: true }); }
        function formatFullDate(date) { return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' }); }
        function formatDateKey(date) { return date.toISOString().split('T')[0]; }
        function formatGroupDate(date) {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = date.toISOString().split('T')[0];
            const todayStr = today.toISOString().split('T')[0];
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            if (dateStr === todayStr) return 'ì˜¤ëŠ˜';
            if (dateStr === yesterdayStr) return 'ì–´ì œ';
            return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
        }
        function formatTimeAgo(date) {
            const diff = new Date() - date;
            const minutes = Math.floor(diff / 60000), hours = Math.floor(diff / 3600000), days = Math.floor(diff / 86400000);
            if (minutes < 1) return 'ë°©ê¸ˆ ì „';
            if (minutes < 60) return minutes + 'ë¶„ ì „';
            if (hours < 24) return hours + 'ì‹œê°„ ì „';
            if (days === 1) return 'ì–´ì œ';
            return days + 'ì¼ ì „';
        }
        function showToast(message) { const toast = document.getElementById('toast'); toast.textContent = message; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 2500); }
        function checkPassword() { 
            const input = document.getElementById('passwordInput'); 
            if (input.value === ADMIN_PASSWORD) { 
                isAdminMode = true; 
                closeModal(); 
                updateAdminUI();
                showToast('ğŸ”“ ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”'); 
            } else { 
                showToast('âŒ ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜'); 
                input.value = ''; 
            } 
        }
        function closeModal() { document.getElementById('passwordModal').classList.remove('active'); document.getElementById('passwordInput').value = ''; }
    </script>
</body>
</html>
